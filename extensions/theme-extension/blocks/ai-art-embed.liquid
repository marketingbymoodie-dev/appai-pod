{% comment %}
  AI Art Studio - App Embed Script
  This script runs on ALL pages and automatically:
  1. Detects products with ai_art_studio.enable metafield
  2. Injects the AI design studio
  3. Hides the native add-to-cart button when configured
  
  No manual theme configuration required - just publish products from the admin!
{% endcomment %}

{% schema %}
{
  "name": "AI Art Studio",
  "target": "body",
  "settings": []
}
{% endschema %}
<div
  id="appai-root"
  data-shop="{{ shop.permanent_domain }}"
  data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
  style="display:none;"
></div>

{% comment %} Output product metafields as JSON for JavaScript to read {% endcomment %}
{% if product and product.metafields.ai_art_studio.app_url %}
<script type="application/json" data-ai-art-studio>
{
  "appUrl": {{ product.metafields.ai_art_studio.app_url.value | json }},
  "productTypeId": {{ product.metafields.ai_art_studio.product_type_id.value | default: "" | json }},
  "displayName": {{ product.metafields.ai_art_studio.display_name.value | default: product.title | json }},
  "description": {{ product.metafields.ai_art_studio.description.value | default: "" | json }},
  "hideAddToCart": {{ product.metafields.ai_art_studio.hide_add_to_cart.value | default: false | json }},
  "enabled": {{ product.metafields.ai_art_studio.enable.value | default: false | json }},
  "productHandle": {{ product.handle | json }},
  "productType": {{ product.type | json }},
  "featuredImageUrl": {{ product.featured_image | image_url: width: 800 | json }}
}
</script>
{% endif %}

<script>
function showLoginRequiredPopup() {
  const overlay = document.createElement("div");
  overlay.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    display: flex; align-items: center; justify-content: center;
    z-index: 999999;
  `;

  const card = document.createElement("div");
  card.style.cssText = `
    width: min(520px, 92vw);
    background: #fff;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,.25);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  `;

  card.innerHTML = `
    <div style="font-size:18px;font-weight:700;margin-bottom:8px;">
      Log in to generate artwork
    </div>
    <div style="font-size:14px;line-height:1.45;color:#333;margin-bottom:12px;">
      We require login so your artwork is automatically saved to your gallery,
      generation limits are applied fairly, and purchase credits can be refunded.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="appai-close" style="
        border:1px solid #ddd;
        background:#fff;
        padding:10px 14px;
        border-radius:10px;
        cursor:pointer;
      ">Not now</button>
      <a href="/account/login" style="
        background:#111;
        color:#fff;
        text-decoration:none;
        padding:10px 14px;
        border-radius:10px;
      ">Log in</a>
    </div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  overlay.querySelector("#appai-close")?.addEventListener("click", () => {
    overlay.remove();
  });
}

(function () {
  'use strict';

  console.log('[AI Art Embed] Script starting...');

  // --- LOGIN GATE (required to generate art) ---
 const customerId = {% if customer %}{{ customer.id | json }}{% else %}null{% endif %}; // always valid JS


  const isProductPageGate =
    window.location.pathname.includes('/products/') ||
    window.location.pathname.includes('/products_preview');

  if (isProductPageGate && !customerId) {
    console.log('[AI Art Embed] No customer logged in -> showing login popup and stopping.');
    showLoginRequiredPopup();
    return; // ⛔ stop everything below
  }
  // --- END LOGIN GATE ---




  // Cart image replacement — run on ALL pages (cart drawers can appear anywhere)
  ;(function aiArtCartReplacer() {
    var MOCKUP_PROP = '_mockup_url';

    // ---- Helpers -----------------------------------------------------------

    var debounceTimer;
    function debounce(fn, wait) {
      wait = wait || 120;
      return function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fn, wait);
      };
    }

    function isVisible(el) {
      if (!el || !(el instanceof Element)) return false;
      var style = getComputedStyle(el);
      if (style.display === 'none' || style.visibility === 'hidden') return false;
      var r = el.getBoundingClientRect();
      return r.width > 0 && r.height > 0;
    }

    function safeUrl(u) {
      if (!u || typeof u !== 'string') return null;
      var s = u.trim();
      if (!s) return null;
      if (/^(https?:)?\/\//i.test(s) || /^data:/i.test(s) || s.charAt(0) === '/') return s;
      return s;
    }

    function getCartJson() {
      return fetch('/cart.js', { credentials: 'same-origin' })
        .then(function(res) {
          if (!res.ok) throw new Error('Failed /cart.js');
          return res.json();
        });
    }

    function maybeCacheBust(url, key) {
      if (!url || !key) return url;
      if (url.indexOf('?') !== -1) return url;
      return url + '?v=' + encodeURIComponent(key);
    }

    // ---- Image swap (wins vs srcset / picture / lazyload) ------------------

    function hardSetImage(img, url) {
      if (!img || !url) return;
      if (img.dataset && img.dataset.mockupApplied === url) return;

      var picture = img.closest ? img.closest('picture') : null;
      if (picture) {
        var sources = picture.querySelectorAll('source');
        for (var i = 0; i < sources.length; i++) {
          sources[i].removeAttribute('srcset');
          sources[i].srcset = '';
          sources[i].removeAttribute('data-srcset');
        }
      }

      img.removeAttribute('srcset');
      img.srcset = '';
      img.removeAttribute('sizes');

      var lazyAttrs = ['data-src', 'data-srcset', 'data-sizes', 'data-original',
                       'data-lazy', 'data-lazy-src', 'data-zoom'];
      for (var j = 0; j < lazyAttrs.length; j++) img.removeAttribute(lazyAttrs[j]);

      img.src = url;
      try { img.loading = 'eager'; img.fetchPriority = 'high'; img.decoding = 'async'; } catch (_) {}

      // Force repaint (helps against some lazyload / render quirks)
      img.style.visibility = 'hidden';
      requestAnimationFrame(function() { img.style.visibility = ''; });

      if (img.dataset) img.dataset.mockupApplied = url;
    }

    // ---- Find cart rows in ANY theme ----------------------------------------

    function getCartRoots() {
      var roots = [];
      var sels = [
        '#CartDrawer', '#cart-drawer', 'cart-drawer',
        '#Cart', '#cart', '#CartContainer', 'cart-items',
        "form[action='/cart']", 'main', 'body'
      ];
      for (var i = 0; i < sels.length; i++) {
        try {
          var nodes = document.querySelectorAll(sels[i]);
          for (var n = 0; n < nodes.length; n++) roots.push(nodes[n]);
        } catch(_) {}
      }
      var seen = [];
      return roots.filter(function(n) {
        if (!n) return false;
        if (seen.indexOf(n) !== -1) return false;
        seen.push(n);
        return true;
      });
    }

    var ROW_ANCESTOR_SEL = '.cart-item, .cart__item, .line-item, tr, li, ' +
      "[class*='cart-item'], [class*='line-item']";

    function collectRowsStrongFirst() {
      var roots = getCartRoots();

      // Phase 1 (best): quantity/update inputs define real line items in most themes
      var fromUpdates = [];
      for (var r = 0; r < roots.length; r++) {
        var inputs = roots[r].querySelectorAll("input[name='updates[]'], input[name^='updates']");
        for (var u = 0; u < inputs.length; u++) {
          var row = inputs[u].closest(ROW_ANCESTOR_SEL) ||
                    inputs[u].closest('tr') ||
                    inputs[u].closest('li') ||
                    inputs[u].closest('div');
          if (row) fromUpdates.push(row);
        }
      }

      var seen = [];
      var rows = [];
      for (var a = 0; a < fromUpdates.length; a++) {
        if (seen.indexOf(fromUpdates[a]) === -1) { seen.push(fromUpdates[a]); rows.push(fromUpdates[a]); }
      }

      // Phase 2 fallback: remove/change controls (only if Phase 1 found nothing)
      if (rows.length < 1) {
        var fromControls = [];
        for (var r2 = 0; r2 < roots.length; r2++) {
          var ctrls = roots[r2].querySelectorAll("a[href*='/cart/change'], button[name='update'], [data-cart-remove]");
          for (var c = 0; c < ctrls.length; c++) {
            var crow = ctrls[c].closest(ROW_ANCESTOR_SEL) ||
                       ctrls[c].closest('tr') ||
                       ctrls[c].closest('li') ||
                       ctrls[c].closest('div');
            if (crow) fromControls.push(crow);
          }
        }
        seen = [];
        rows = [];
        for (var b = 0; b < fromControls.length; b++) {
          if (seen.indexOf(fromControls[b]) === -1) { seen.push(fromControls[b]); rows.push(fromControls[b]); }
        }
      }

      // Must contain image or updates input
      rows = rows.filter(function(r) {
        return r.querySelector('img') || r.querySelector("input[name='updates[]'], input[name^='updates']");
      });

      // Prefer visible rows (drawers often include hidden templates)
      var visible = rows.filter(isVisible);
      if (visible.length) rows = visible;

      // Prune nested duplicates (keep outermost)
      var pruned = [];
      for (var i = 0; i < rows.length; i++) {
        var contained = false;
        for (var j = 0; j < pruned.length; j++) {
          if (pruned[j].contains(rows[i])) { contained = true; break; }
        }
        if (!contained) pruned.push(rows[i]);
      }

      return pruned;
    }

    var SIGNAL_SEL = [
      "input[name='updates[]']", "input[name^='updates']",
      "a[href*='/cart/change']", "button[name='update']", "[data-cart-remove]"
    ].join(',');

    function findBestImageInRow(row) {
      if (!row) return null;

      if (!row.querySelector(SIGNAL_SEL) &&
          !row.querySelector("[class*='quantity'], [data-quantity], input[type='number']")) {
        return null;
      }

      var sels = [
        'picture img',
        '.cart-item__image img', '.cart__image img', '.line-item__image img',
        'img'
      ];
      for (var i = 0; i < sels.length; i++) {
        var img = row.querySelector(sels[i]);
        if (img && img.tagName === 'IMG' && isVisible(img)) return img;
      }
      return null;
    }

    // ---- Apply logic -------------------------------------------------------

    var applying = false;

    function applyMockupsOnce() {
      if (applying) return;
      applying = true;

      getCartJson()
        .then(function(cart) {
          var items = cart.items || [];
          if (!items.length) { applying = false; return; }

          var rows = collectRowsStrongFirst();
          if (!rows.length) { applying = false; return; }

          var n = Math.min(items.length, rows.length);
          var swapped = 0;

          for (var i = 0; i < n; i++) {
            var url = safeUrl(items[i] && items[i].properties ? items[i].properties[MOCKUP_PROP] : null);
            if (!url) continue;

            url = maybeCacheBust(url, items[i].key);

            var img = findBestImageInRow(rows[i]);
            hardSetImage(img, url);
            if (img && img.dataset && img.dataset.mockupApplied === url) swapped++;
          }

          applying = false;
        })
        .catch(function() {
          applying = false;
        });
    }

    var applyMockups = debounce(applyMockupsOnce, 120);

    window.aiArtFastReplace = applyMockupsOnce;
    window.__applyCartMockups = applyMockupsOnce;

    // ---- Re-render detection -----------------------------------------------

    // 1) Initial
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() { applyMockups(); });
    } else {
      applyMockups();
    }

    // 2) bfcache restore / normal pageshow
    window.addEventListener('pageshow', function() { applyMockups(); });

    // 3) Custom events (safe if unused)
    document.addEventListener('cart:updated', applyMockups);
    document.addEventListener('cart:refresh', applyMockups);

    // 4) Shopify section events (safe if unused)
    document.addEventListener('shopify:section:load', applyMockups);
    document.addEventListener('shopify:section:unload', applyMockups);
    document.addEventListener('shopify:section:select', applyMockups);
    document.addEventListener('shopify:section:deselect', applyMockups);

    // 5) MutationObserver catch-all
    try {
      var mo = new MutationObserver(function() { applyMockups(); });
      mo.observe(document.documentElement, { childList: true, subtree: true });
    } catch(_) {}

    // 6) fetch() intercept
    var origFetch = window.fetch;
    window.fetch = function() {
      var args = arguments;
      return origFetch.apply(this, args).then(function(res) {
        try {
          var u = typeof args[0] === 'string' ? args[0] : (args[0] && args[0].url ? args[0].url : '');
          if (/\/cart(\/|\.js|\?|$)/.test(u) || /sections=/.test(u)) {
            requestAnimationFrame(function() { applyMockups(); });
            setTimeout(function() { applyMockups(); }, 200);
          }
        } catch(_) {}
        return res;
      });
    };

    // 7) XHR intercept
    var origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function() {
      this.__url = arguments[1];
      return origOpen.apply(this, arguments);
    };
    var origSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function() {
      var self = this;
      self.addEventListener('loadend', function() {
        try {
          var u = self.__url || '';
          if (/\/cart(\/|\.js|\?|$)/.test(u) || /sections=/.test(u)) {
            applyMockups();
            setTimeout(function() { applyMockups(); }, 200);
          }
        } catch(_) {}
      });
      return origSend.apply(self, arguments);
    };
  })();
  
  // Only run product page logic on product pages
  var isProductPage = window.location.pathname.includes('/products/') || 
                      window.location.pathname.includes('/products_preview');
  
  if (!isProductPage) {
    console.log('[AI Art Embed] Not a product page, skipping product logic. Path:', window.location.pathname);
    return;
  }
  console.log('[AI Art Embed] On product page, continuing...');
  
  // Set up GLOBAL message listener for mockups - runs regardless of how embed was added
  console.log('[AI Art Embed] Setting up global message listener...');
  window.addEventListener('message', function(event) {
    // Only process our message types
    if (!event.data || !event.data.type) return;
    
    // Log messages from our app
    if (event.data.type === 'AI_ART_STUDIO_MOCKUPS' || 
        (event.data.type && event.data.type.indexOf('ai-art-studio') !== -1)) {
      console.log('[AI Art Embed] Global listener received:', event.data.type, 'from:', event.origin);
    }
    
    // Handle mockup updates from Railway app origin
    if (event.data.type === 'AI_ART_STUDIO_MOCKUPS') {
      // Security: only accept from Railway origins
      if (event.origin.indexOf('railway.app') === -1) {
        console.log('[AI Art Embed] Ignoring mockups from non-Railway origin:', event.origin);
        return;
      }
      
      var mockupUrls = event.data.mockupUrls;
      if (!mockupUrls || mockupUrls.length === 0) {
        console.log('[AI Art Embed] No mockup URLs in message');
        return;
      }
      
      console.log('[AI Art Embed] Processing', mockupUrls.length, 'mockups - creating custom gallery');

      // Hide the placeholder (it was shown while generating)
      var phEl = document.getElementById('ai-art-placeholder');
      if (phEl) phEl.style.display = 'none';

      // Ensure the native gallery is hidden (in case placeholder wasn't created)
      var nativeGallery = aiArtNativeGallery; // prefer the one already found by createPlaceholderGallery
      if (!nativeGallery) {
        var ngSelectors = [
          '.product__media-wrapper', '.product__media-gallery',
          '.product-single__photos', '.product__images',
          '.product-gallery', '.product__photo-container',
          '.product-images', '.product-media',
          '[data-product-media-container]', '[data-product-images]',
          '[data-media-gallery]', '.product__media-list',
          '.product__media', '.product-single__media-wrapper',
          '.product-featured-media'
        ];
        for (var i = 0; i < ngSelectors.length; i++) {
          nativeGallery = document.querySelector(ngSelectors[i]);
          if (nativeGallery) {
            nativeGallery.style.display = 'none';
            break;
          }
        }
      }

      // Create or update our custom gallery
      var customGallery = document.getElementById('ai-art-custom-gallery');
      if (!customGallery) {
        customGallery = document.createElement('div');
        customGallery.id = 'ai-art-custom-gallery';
        customGallery.style.cssText = 'width:100%;max-width:600px;margin-bottom:20px;';

        // Main image container
        var mainImageContainer = document.createElement('div');
        mainImageContainer.id = 'ai-art-main-image';
        mainImageContainer.style.cssText = 'width:100%;aspect-ratio:1/1;background:#f5f5f5;border-radius:8px;overflow:hidden;margin-bottom:12px;';

        var mainImg = document.createElement('img');
        mainImg.id = 'ai-art-main-img';
        mainImg.style.cssText = 'width:100%;height:100%;object-fit:contain;';
        mainImg.alt = 'Your custom design mockup';
        mainImageContainer.appendChild(mainImg);
        customGallery.appendChild(mainImageContainer);

        // Thumbnails container
        var thumbsContainer = document.createElement('div');
        thumbsContainer.id = 'ai-art-thumbs';
        thumbsContainer.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;';
        customGallery.appendChild(thumbsContainer);

        // Insert where the placeholder was, or before the hidden native gallery
        var insertRef = phEl || nativeGallery;
        if (insertRef && insertRef.parentNode) {
          insertRef.parentNode.insertBefore(customGallery, insertRef);
        } else {
          var productArea = document.querySelector('.product') ||
                           document.querySelector('[data-product]') ||
                           document.querySelector('main');
          if (productArea) productArea.insertBefore(customGallery, productArea.firstChild);
        }
        console.log('[AI Art Embed] Created custom gallery');
      }
      
      // Update main image
      var mainImg = document.getElementById('ai-art-main-img');
      if (mainImg) {
        mainImg.src = mockupUrls[0];
        console.log('[AI Art Embed] Set main image to first mockup');
      }
      
      // Update thumbnails
      var thumbsContainer = document.getElementById('ai-art-thumbs');
      if (thumbsContainer) {
        thumbsContainer.innerHTML = '';
        
        mockupUrls.forEach(function(url, index) {
          var thumb = document.createElement('div');
          thumb.className = 'ai-art-thumb';
          thumb.style.cssText = 'width:70px;height:70px;cursor:pointer;border:2px solid ' + (index === 0 ? '#000' : '#ddd') + ';border-radius:6px;overflow:hidden;transition:border-color 0.2s;';
          
          var thumbImg = document.createElement('img');
          thumbImg.src = url;
          thumbImg.alt = 'View ' + (index + 1);
          thumbImg.style.cssText = 'width:100%;height:100%;object-fit:cover;';
          thumb.appendChild(thumbImg);
          
          thumb.onclick = function() {
            // Update main image
            if (mainImg) mainImg.src = url;
            
            // Update thumbnail borders
            var allThumbs = thumbsContainer.querySelectorAll('.ai-art-thumb');
            allThumbs.forEach(function(t) { t.style.borderColor = '#ddd'; });
            thumb.style.borderColor = '#000';
            
            console.log('[AI Art Embed] Selected mockup', index + 1);
          };
          
          thumbsContainer.appendChild(thumb);
        });
        
        console.log('[AI Art Embed] Added', mockupUrls.length, 'thumbnails below main image');
      }
      
    }
  });
  
  // Skip if already initialized
  if (document.getElementById('ai-art-studio-auto-embed')) {
    console.log('[AI Art Embed] Already initialized, skipping');
    return;
  }

  // Skip if there's already an iframe from body_html (legacy products)
  var existingIframe = document.querySelector('#ai-art-studio-container iframe, iframe[title="AI Design Studio"]');
  if (existingIframe) {
    console.log('[AI Art Embed] Found existing iframe in body_html, skipping auto-embed');
    return;
  }

  function hideNativeAddToCart() {
    const selectors = [
      'form[action="/cart/add"]',
      '.product-form__submit',
      '.product-form__buttons',
      '[data-add-to-cart]',
      '.add-to-cart',
      '#AddToCart',
      '.shopify-payment-button',
      '.product__submit',
      'button[name="add"]',
      '.product-form__cart-submit'
    ];
    
    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => {
        if (!el.closest('.ai-art-studio-embed')) {
          el.style.display = 'none';
        }
      });
    });
    
    const productForms = document.querySelectorAll('form[action*="/cart/add"]');
    productForms.forEach(form => {
      if (!form.closest('.ai-art-studio-embed')) {
        form.style.display = 'none';
      }
    });
  }
  
  function createDesignStudio(config) {
    const container = document.createElement('div');
    container.className = 'ai-art-studio-embed';
    container.id = 'ai-art-studio-auto-embed';
    
    container.innerHTML = `
      <div class="ai-art-studio-embed__wrapper">
        <h2 class="ai-art-studio-embed__heading">Create Your Custom Design</h2>
        <p class="ai-art-studio-embed__description">${config.description || 'Use AI to generate a unique artwork. Describe your vision and our AI will bring it to life.'}</p>
        <div class="ai-art-studio-embed__studio" style="height:600px;">
          <div class="ai-art-studio-embed__loading">
            <div class="ai-art-studio-embed__spinner"></div>
            <p>Loading design studio...</p>
          </div>
        </div>
        <div id="ai-art-atc-wrapper" style="display:none;margin-top:14px;">
          <button id="ai-art-atc-btn" disabled class="ai-art-atc-btn">
            Create your design first
          </button>
        </div>
      </div>
    `;
    
    const studioContainer = container.querySelector('.ai-art-studio-embed__studio');
    
    const params = new URLSearchParams();
    params.set('storefront', 'true');  // IMPORTANT: Use storefront=true, NOT embedded=true
    params.set('shopify', 'true');
    params.set('shop', config.shopDomain);
    params.set('productTypeId', config.productTypeId);
    params.set('productId', config.productId);
    params.set('productHandle', config.productHandle);
    params.set('productTitle', config.productTitle);
    params.set('displayName', config.displayName);
    params.set('showPresets', 'true');
    if (config.selectedVariant) {
      params.set('selectedVariant', config.selectedVariant);
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedDesignId = urlParams.get('sharedDesignId');
    if (sharedDesignId) {
      params.set('sharedDesignId', sharedDesignId);
    }
    
    const iframe = document.createElement('iframe');
    iframe.src = `${config.appUrl}/embed/design?${params.toString()}`;
    iframe.allow = 'clipboard-write';
    iframe.title = 'AI Art Design Studio';
    iframe.style.cssText = 'width: 100%; height: 100%; border: none; overflow: hidden; display: block;';
    
    iframe.onload = function() {
      const loading = studioContainer.querySelector('.ai-art-studio-embed__loading');
      if (loading) loading.remove();
    };
    
    studioContainer.appendChild(iframe);
    
    // ================================================================
    // AI Art Bridge v1.0.0 — Production-grade storefront bridge
    // ================================================================
    var BRIDGE_VERSION = '1.0.0';
    window.AI_ART_STUDIO_BRIDGE_VERSION = BRIDGE_VERSION;

    var B = '[AI Art Bridge]'; // log prefix
    console.log(B, 'Installing bridge', BRIDGE_VERSION, 'appUrl:', config.appUrl);

    // --- Strict origin allowlist ---
    var appOrigin = '';
    try { appOrigin = new URL(config.appUrl).origin; } catch(e) {}
    var ALLOWED_ORIGINS = [
      appOrigin,
      'https://appai-pod-production.up.railway.app'
    ].filter(Boolean);
    console.log(B, 'Allowed origins:', ALLOWED_ORIGINS);

    // --- Origin validation ---
    function isFromOurIframe(event) {
      try { return event.source === iframe.contentWindow; } catch(e) { return false; }
    }

    function isAllowedOrigin(origin) {
      if (!origin || origin === 'null') return false;
      if (ALLOWED_ORIGINS.indexOf(origin) !== -1) return true;
      // Also allow any *.railway.app as staging fallback
      try { return new URL(origin).hostname.endsWith('.railway.app'); } catch(e) { return false; }
    }

    function isTrustedMessage(event) {
      // 1) Source identity — most reliable, works with "null" origins from Shopify CDN proxy
      if (isFromOurIframe(event)) return true;
      // 2) Origin in allowlist
      if (isAllowedOrigin(event.origin)) return true;
      // 3) Null origin with our protocol prefix (Shopify CDN/proxy rewrites)
      if ((!event.origin || event.origin === 'null') &&
          event.data && typeof event.data.type === 'string' &&
          event.data.type.indexOf('AI_ART_STUDIO') === 0) {
        console.log(B, 'Accepting null-origin AI_ART_STUDIO message:', event.data.type);
        return true;
      }
      return false;
    }

    // --- Reply helper: always reply via event.source + strict origin ---
    function replyToIframe(eventOrNull, msg) {
      var targets = [];
      // Prefer event.source + event.origin (spec-correct)
      if (eventOrNull && eventOrNull.source) {
        var replyOrigin = isAllowedOrigin(eventOrNull.origin) ? eventOrNull.origin : (appOrigin || '*');
        targets.push({ target: eventOrNull.source, origin: replyOrigin, label: 'event.source' });
      }
      // Fallback: iframe.contentWindow + appOrigin
      targets.push({ target: iframe.contentWindow, origin: appOrigin || '*', label: 'iframe.cw' });

      for (var i = 0; i < targets.length; i++) {
        try {
          targets[i].target.postMessage(msg, targets[i].origin);
          console.log(B, 'Reply sent via', targets[i].label, 'origin:', targets[i].origin, 'type:', msg.type);
          return;
        } catch(e) {
          console.warn(B, 'Reply via', targets[i].label, 'failed:', e.message);
        }
      }
      // Last resort: wildcard
      try {
        iframe.contentWindow.postMessage(msg, '*');
        console.log(B, 'Reply sent via wildcard fallback');
      } catch(e) {
        console.error(B, 'ALL reply methods failed:', e.message);
      }
    }

    // --- Cart add via Shopify Ajax API ---
    function addToCart(variantId, quantity, properties) {
      if (!variantId) return Promise.reject(new Error('Missing variantId'));

      var body = { items: [{ id: Number(variantId), quantity: quantity || 1, properties: properties || {} }] };
      console.log(B, '_mockup_url being sent:', properties && properties['_mockup_url'] ? properties['_mockup_url'] : '(none)');
      console.log(B, 'POST /cart/add.js', JSON.stringify(body).substring(0, 400));

      var controller = new AbortController();
      var tid = setTimeout(function() { controller.abort(); }, 15000);

      return fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(body),
        credentials: 'same-origin',
        signal: controller.signal
      }).then(function(res) {
        clearTimeout(tid);
        console.log(B, '/cart/add.js status:', res.status);
        return res.text().then(function(text) {
          var json;
          try { json = JSON.parse(text); } catch(e) { json = { raw: text }; }
          if (!res.ok) throw new Error('Cart add failed: ' + ((json && (json.description || json.message)) || text || 'HTTP ' + res.status));

          // After successful add, fetch full cart state for diagnostics
          fetch('/cart.js', { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(cart) {
              var lastItem = cart.items && cart.items.length > 0 ? cart.items[cart.items.length - 1] : null;
              console.log(B, '/cart.js after add — item_count:', cart.item_count, 'last_item:', lastItem ? { title: lastItem.title, variant_id: lastItem.variant_id, has_mockup: !!(lastItem.properties && lastItem.properties['_mockup_url']) } : null);
            })
            .catch(function(e) { console.warn(B, 'Post-add /cart.js fetch failed:', e.message); });

          return json;
        });
      }).catch(function(err) {
        clearTimeout(tid);
        if (err.name === 'AbortError') throw new Error('Cart request timed out after 15s');
        throw err;
      });
    }

    // --- Refresh cart UI after successful add ---
    function refreshCartUI() {
      document.dispatchEvent(new CustomEvent('cart:refresh'));

      // Strategy 1: Dawn/OS 2.0 — re-render cart drawer via Section Rendering API
      var cartDrawer = document.querySelector('cart-drawer');
      var cartNotification = document.querySelector('cart-notification');

      if (cartDrawer || cartNotification) {
        var target = cartDrawer || cartNotification;
        var sectionWrapper = target.closest('[id^="shopify-section-"]');
        var sectionId = sectionWrapper ? sectionWrapper.id.replace('shopify-section-', '') : null;

        if (sectionId) {
          console.log(B, 'Fetching section render for:', sectionId);
          fetch('/?sections=' + sectionId)
            .then(function(r) { return r.json(); })
            .then(function(sections) {
              var html = sections[sectionId];
              if (html && sectionWrapper) {
                var parsed = new DOMParser().parseFromString(html, 'text/html');
                var newContent = parsed.querySelector('[id="' + sectionWrapper.id + '"]');
                sectionWrapper.innerHTML = newContent ? newContent.innerHTML : html;

                // Apply stored mockup immediately to the freshly-injected DOM
                // (zero delay, no /cart.js fetch needed)
                if (typeof window.aiArtFastReplace === 'function') window.aiArtFastReplace();

                // Re-query and open the drawer
                var newDrawer = document.querySelector('cart-drawer');
                if (newDrawer) {
                  var details = newDrawer.querySelector('details');
                  if (details) details.open = true;
                  newDrawer.classList.add('active');
                  console.log(B, 'Opened cart-drawer via Section Rendering API');
                }
                // Re-trigger cart image replacement after new DOM is injected
                document.dispatchEvent(new CustomEvent('cart:refresh'));
                var newNotification = document.querySelector('cart-notification');
                if (newNotification) {
                  newNotification.classList.add('active');
                  try { if (typeof newNotification.open === 'function') newNotification.open(); } catch(e) {}
                }
              }
            }).catch(function(e) { console.warn(B, 'Section render failed:', e); });
        }
      }

      // Strategy 2: Click the native cart trigger (for non-Dawn themes)
      if (!cartDrawer && !cartNotification) {
        setTimeout(function() {
          var triggers = [
            '#cart-icon-bubble', '[data-cart-trigger]',
            'button[aria-controls*="cart" i]',
            '.header__icon--cart', '.cart-icon-bubble',
            '[data-action="toggle-cart"]', 'a[href="/cart"]'
          ];
          for (var i = 0; i < triggers.length; i++) {
            try {
              var btn = document.querySelector(triggers[i]);
              if (btn) {
                console.log(B, 'Opening cart via trigger click:', triggers[i]);
                btn.click();
                break;
              }
            } catch(e) {}
          }
        }, 300);
      }

      // Dispatch theme-agnostic events so any theme listening can react
      document.dispatchEvent(new CustomEvent('cart:updated'));

      // Update cart count badges and verify UI updated
      fetch('/cart.js', { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(cart) {
        document.querySelectorAll('.cart-count, .cart-count-bubble, [data-cart-count]').forEach(function(el) {
          el.textContent = String(cart.item_count);
          el.style.display = cart.item_count > 0 ? '' : 'none';
        });

        // Fallback: if cart has items but no drawer/notification opened after 2s,
        // navigate to /cart so the user can see their item
        if (cart.item_count > 0) {
          setTimeout(function() {
            var drawerVisible = document.querySelector('cart-drawer.active, cart-drawer [open], cart-notification.active');
            var cartPage = window.location.pathname === '/cart';
            if (!drawerVisible && !cartPage) {
              console.log(B, 'Cart UI did not open — redirecting to /cart');
              window.location.href = '/cart';
            }
          }, 2000);
        }
      }).catch(function() {});
    }

    // --- BRIDGE_READY heartbeat ---
    // React app inside iframe may not have mounted when iframe.onload fires.
    // Send BRIDGE_READY every 500ms until the iframe ACKs.
    var bridgeAcked = false;
    var heartbeatN = 0;
    var MAX_HEARTBEATS = 240; // 120s — Railway cold start can take up to 60s
    var heartbeatTimer = null;

    function sendBridgeReady() {
      if (bridgeAcked) return;
      try {
        // Use '*' for BRIDGE_READY — this is a non-sensitive handshake ping.
        // Using appOrigin can silently fail if the iframe's effective origin
        // differs (e.g. Shopify CDN proxy, redirect, or cross-origin quirk).
        iframe.contentWindow.postMessage({
          type: 'AI_ART_STUDIO_BRIDGE_READY',
          _bridgeVersion: BRIDGE_VERSION,
          timestamp: Date.now(),
          heartbeat: heartbeatN
        }, '*');
        if (heartbeatN % 10 === 0) console.log(B, 'BRIDGE_READY heartbeat #' + heartbeatN);
        heartbeatN++;
      } catch(e) {
        console.warn(B, 'Failed to send BRIDGE_READY:', e.message);
      }
    }

    iframe.addEventListener('load', function() {
      console.log(B, 'Iframe loaded, starting BRIDGE_READY heartbeat');
      sendBridgeReady();
      heartbeatTimer = setInterval(function() {
        if (bridgeAcked || heartbeatN >= MAX_HEARTBEATS) {
          clearInterval(heartbeatTimer);
          heartbeatTimer = null;
          if (!bridgeAcked) console.error(B, 'Bridge never acknowledged after', MAX_HEARTBEATS, 'heartbeats');
          return;
        }
        sendBridgeReady();
      }, 500);
    });

    // --- Main message listener ---
    window.addEventListener('message', function(event) {
      var data = event.data;
      if (!data || typeof data.type !== 'string') return;

      var isOurs = data.type.indexOf('AI_ART_STUDIO') === 0 || data.type.indexOf('ai-art-studio') === 0;

      // Debug logging
      if (isOurs) {
        console.log(B, 'MSG:', data.type, 'origin:', event.origin, 'fromIframe:', isFromOurIframe(event));
      }

      // Trust gate
      if (!isTrustedMessage(event)) {
        if (isOurs) console.warn(B, 'BLOCKED untrusted:', data.type, 'origin:', event.origin);
        return;
      }

      // ===== BRIDGE_ACK =====
      if (data.type === 'AI_ART_STUDIO_BRIDGE_ACK') {
        bridgeAcked = true;
        if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; }
        console.log(B, 'Handshake COMPLETE. parent:', BRIDGE_VERSION, 'iframe:', data._bridgeVersion, 'after', heartbeatN, 'heartbeats');
        return;
      }

      // ===== IFRAME_READY (iframe mounted before heartbeat reached it) =====
      if (data.type === 'AI_ART_STUDIO_IFRAME_READY') {
        console.log(B, 'Iframe announced READY, sending BRIDGE_READY immediately');
        sendBridgeReady();
        return;
      }

      // ===== PING → PONG =====
      if (data.type === 'AI_ART_STUDIO_PING') {
        console.log(B, 'PING received, replying PONG');
        replyToIframe(event, {
          type: 'AI_ART_STUDIO_PONG',
          _bridgeVersion: BRIDGE_VERSION,
          pingTimestamp: data.timestamp
        });
        return;
      }

      // ===== ADD TO CART =====
      if (data.type === 'AI_ART_STUDIO_ADD_TO_CART') {
        var cid = data.correlationId || '';
        console.log(B, '>>> ADD_TO_CART cid:', cid, 'variant:', data.variantId);

        // Store mockup URL for diagnostics; cart replacer re-fetches /cart.js each pass
        if (data.properties && data.properties['_mockup_url']) {
          window.__aiArtRecentMockup = { variantId: String(data.variantId), url: data.properties['_mockup_url'], designId: data.properties['_design_id'] || '' };
        }

        if (!data.variantId) {
          replyToIframe(event, {
            type: 'AI_ART_STUDIO_ADD_TO_CART_RESULT',
            correlationId: cid, ok: false, success: false,
            error: 'Missing variant ID', _bridgeVersion: BRIDGE_VERSION
          });
          return;
        }

        addToCart(data.variantId, data.quantity, data.properties)
          .then(function(cart) {
            console.log(B, 'Cart add SUCCESS for cid:', cid);
            replyToIframe(event, {
              type: 'AI_ART_STUDIO_ADD_TO_CART_RESULT',
              correlationId: cid, ok: true, success: true,
              cart: cart, result: cart, _bridgeVersion: BRIDGE_VERSION
            });
            refreshCartUI();
          })
          .catch(function(err) {
            console.error(B, 'Cart add FAILED for cid:', cid, err.message);
            replyToIframe(event, {
              type: 'AI_ART_STUDIO_ADD_TO_CART_RESULT',
              correlationId: cid, ok: false, success: false,
              error: err.message || String(err), _bridgeVersion: BRIDGE_VERSION
            });
          });
        return;
      }

      // ===== LEGACY ADD TO CART =====
      if (data.type === 'ai-art-studio:add-to-cart') {
        console.log(B, 'Legacy add-to-cart variant:', data.variantId);
        addToCart(data.variantId, 1, { '_artwork_url': data.artworkUrl || '', '_design_id': data.designId || '', 'Artwork': 'Custom AI Design' })
          .then(function(cart) {
            replyToIframe(event, { type: 'ai-art-studio:cart-updated', success: true, cart: cart });
            refreshCartUI();
          })
          .catch(function(err) {
            replyToIframe(event, { type: 'ai-art-studio:cart-updated', success: false, error: err.message });
          });
        return;
      }

      // ===== RESIZE =====
      if (data.type === 'ai-art-studio:resize') {
        var newH = Math.max(data.height || 0, 400);
        studioContainer.style.height = newH + 'px';
        return;
      }

      // ===== CART STATE (parent button sync) =====
      if (data.type === 'AI_ART_STUDIO_CART_STATE') {
        var atcBtnEl = document.getElementById('ai-art-atc-btn');
        var atcWrapperEl = document.getElementById('ai-art-atc-wrapper');
        if (atcBtnEl && atcWrapperEl) {
          atcWrapperEl.style.display = 'block';
          // Don't overwrite button text while it shows "Adding…" or "Added ✓"
          var currentText = atcBtnEl.textContent || '';
          var isBusy = currentText.indexOf('Adding') !== -1 || currentText.indexOf('Added') !== -1;
          if (!isBusy) {
            atcBtnEl.textContent = data.label || 'Add to Cart';
            atcBtnEl.style.background = '';
          }
          atcBtnEl.disabled = !!data.disabled;
          atcBtnEl.style.opacity = data.disabled ? '0.5' : '1';
          atcBtnEl.style.cursor = data.disabled ? 'not-allowed' : 'pointer';
          if (data.payload) {
            atcBtnEl.dataset.payload = JSON.stringify(data.payload);
          }
        }
        return;
      }

      // ===== MOCKUP LOADING STATE =====
      if (data.type === 'AI_ART_STUDIO_MOCKUP_LOADING') {
        var genOverlay = document.getElementById('ai-art-gen-overlay');
        if (genOverlay) {
          genOverlay.style.display = data.loading ? 'flex' : 'none';
        }
        return;
      }

      // ===== MOCKUPS =====
      if (data.type === 'AI_ART_STUDIO_MOCKUPS') {
        var mockupUrls = data.mockupUrls;
        if (!mockupUrls || mockupUrls.length === 0) return;
        console.log(B, 'Received mockups:', mockupUrls.length);

        // Mockup preview grid removed — images are already shown in the
        // custom gallery above (#ai-art-custom-gallery) which replaced the
        // native product image gallery.
        console.log(B, 'Mockup gallery updated');
      }
    });

    console.log(B, 'Bridge installed successfully.');

    // --- Parent-side Add to Cart button ---
    var atcBtn = container.querySelector('#ai-art-atc-btn');
    if (atcBtn) {
      atcBtn.addEventListener('click', function() {
        var payloadJson = atcBtn.dataset.payload || '{}';
        var payload;
        try { payload = JSON.parse(payloadJson); } catch(e) { payload = {}; }
        if (!payload.variantId) return;

        atcBtn.textContent = 'Adding to Cart\u2026';
        atcBtn.disabled = true;
        atcBtn.style.opacity = '0.7';

        // Store mockup for instant cart drawer replacement
        var mockupUrl = payload.properties && payload.properties['_mockup_url'];
        if (mockupUrl) {
          window.__aiArtRecentMockup = { variantId: String(payload.variantId), url: mockupUrl, designId: (payload.properties && payload.properties['_design_id']) || '' };
        }

        addToCart(payload.variantId, payload.quantity || 1, payload.properties || {})
          .then(function(cart) {
            // Notify iframe of success so it can show its success state
            try {
              iframe.contentWindow.postMessage({
                type: 'AI_ART_STUDIO_ADD_TO_CART_RESULT',
                correlationId: payload.correlationId || '',
                ok: true, success: true,
                cart: cart, result: cart,
                _bridgeVersion: BRIDGE_VERSION
              }, '*');
            } catch(e) {}

            // Fire-and-forget: update variant image for checkout display
            if (mockupUrl && mockupUrl.indexOf('https://') === 0 && config.productId) {
              fetch(config.appUrl + '/api/storefront/variant-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  shop: config.shopDomain,
                  productId: config.productId,
                  variantId: String(payload.variantId),
                  mockupUrl: mockupUrl
                })
              }).catch(function(e) { console.warn(B, 'Variant image update failed:', e.message); });
            }

            atcBtn.textContent = 'Added to Cart \u2713';
            atcBtn.style.background = '#2d7a2d';
            atcBtn.disabled = false;
            atcBtn.style.opacity = '1';
            refreshCartUI();
          })
          .catch(function(err) {
            try {
              iframe.contentWindow.postMessage({
                type: 'AI_ART_STUDIO_ADD_TO_CART_RESULT',
                correlationId: payload.correlationId || '',
                ok: false, success: false,
                error: err.message,
                _bridgeVersion: BRIDGE_VERSION
              }, '*');
            } catch(e) {}
            atcBtn.textContent = 'Error \u2014 Try Again';
            atcBtn.style.background = '#c0392b';
            atcBtn.disabled = false;
            atcBtn.style.opacity = '1';
            // Reset button appearance after 3 seconds
            setTimeout(function() {
              atcBtn.style.background = '';
              atcBtn.textContent = 'Add to Cart';
            }, 3000);
          });
      });
    }

    return container;
  }
  
  var aiArtNativeGallery = null; // reference kept so we can restore it if needed

  function createPlaceholderGallery() {
    if (document.getElementById('ai-art-placeholder')) return; // already created

    var nativeGallerySelectors = [
      '.product__media-wrapper',
      '.product__media-gallery',
      '.product-single__photos',
      '.product__images',
      '.product-gallery',
      '.product__photo-container',
      '.product-images',
      '.product-media',
      '[data-product-media-container]',
      '[data-product-images]',
      '[data-media-gallery]',
      '.product__media-list',
      '.product__media',
      '.product-single__media-wrapper',
      '.product-featured-media'
    ];

    var native = null;
    for (var gi = 0; gi < nativeGallerySelectors.length; gi++) {
      native = document.querySelector(nativeGallerySelectors[gi]);
      if (native) {
        console.log('[AI Art Embed] Found native gallery with:', nativeGallerySelectors[gi]);
        break;
      }
    }

    // Fallback: find the first container with product images near the product info
    if (!native) {
      var productContainer = document.querySelector('.product, [data-product], .product-template, main');
      if (productContainer) {
        var imgs = productContainer.querySelectorAll('img');
        for (var ii = 0; ii < imgs.length; ii++) {
          var parentEl = imgs[ii].closest('[class*="media"], [class*="gallery"], [class*="image"], [class*="photo"]');
          if (parentEl && !parentEl.closest('.ai-art-studio-embed')) {
            native = parentEl;
            console.log('[AI Art Embed] Found native gallery via image fallback:', native.className);
            break;
          }
        }
      }
    }

    if (!native) {
      console.log('[AI Art Embed] Could not find native gallery - skipping placeholder');
      return;
    }

    // Hide the native gallery — replaced by our placeholder / custom gallery
    native.style.display = 'none';
    native.dataset.aiHidden = 'true';
    aiArtNativeGallery = native;

    var ph = document.createElement('div');
    ph.id = 'ai-art-placeholder';
    // max-width matches the custom gallery so the page layout doesn't shift
    ph.style.cssText = 'width:100%;max-width:600px;aspect-ratio:1/1;background:#f0f0f0;border-radius:8px;overflow:hidden;margin-bottom:20px;position:relative;';

    // Prefer the Liquid-rendered original product image (immune to variant image mutations
    // that happen when a user adds a custom design to cart). Fall back to DOM scraping.
    var liquidImgSrc = '';
    var scriptDataEl = document.querySelector('[data-ai-art-studio]');
    if (scriptDataEl) {
      try {
        var scriptData = JSON.parse(scriptDataEl.textContent);
        if (scriptData.featuredImageUrl) {
          liquidImgSrc = scriptData.featuredImageUrl;
        }
      } catch(e) {}
    }

    var imgSrc = liquidImgSrc;
    var imgSrcset = '';

    if (!imgSrc) {
      // Fallback: scrape first image from native gallery
      var firstProductImg = native.querySelector('img[src]:not([src=""]), img[data-src]:not([data-src=""])');
      if (firstProductImg) {
        imgSrc = firstProductImg.src || firstProductImg.dataset.src || '';
        imgSrcset = firstProductImg.srcset || firstProductImg.dataset.srcset || '';
      }
    }

    if (imgSrc) {
      var placeholderProductImg = document.createElement('img');
      placeholderProductImg.src = imgSrc;
      if (imgSrcset) placeholderProductImg.srcset = imgSrcset;
      placeholderProductImg.alt = 'Product image';
      placeholderProductImg.style.cssText = 'width:100%;height:100%;object-fit:contain;display:block;';
      ph.appendChild(placeholderProductImg);
    }

    // Overlay shown while mockups are generating (hidden initially)
    var overlay = document.createElement('div');
    overlay.id = 'ai-art-gen-overlay';
    overlay.style.cssText = 'display:none;position:absolute;inset:0;background:rgba(255,255,255,0.88);flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:10;';
    overlay.innerHTML = '<div class="ai-art-spinner"></div><span style="font-size:14px;color:#555;font-weight:500;letter-spacing:0.01em;">Artwork Generating\u2026</span>';
    ph.appendChild(overlay);

    native.parentNode.insertBefore(ph, native);
    console.log('[AI Art Embed] Created placeholder gallery. liquidImg:', !!liquidImgSrc, 'fallbackImg:', !liquidImgSrc && !!imgSrc);
  }

  function insertStudioAfterProductInfo(studioElement) {
    const insertionPoints = [
      '.product__info-wrapper',
      '.product-single__meta',
      '.product__content',
      '.product-info',
      '[data-product-info]',
      '.product__description',
      '.product-description'
    ];
    
    for (const selector of insertionPoints) {
      const target = document.querySelector(selector);
      if (target) {
        target.parentNode.insertBefore(studioElement, target.nextSibling);
        return true;
      }
    }
    
    const productContainer = document.querySelector('.product, [data-product], .product-template, main');
    if (productContainer) {
      productContainer.appendChild(studioElement);
      return true;
    }
    
    return false;
  }
  
  function init() {
    var isProductPage = window.location.pathname.includes('/products/') || 
                        window.location.pathname.includes('/products_preview');
    if (!isProductPage) {
      return;
    }
    
    if (document.getElementById('ai-art-studio-auto-embed')) {
      return;
    }
    
    const productMeta = document.querySelector('[data-product-json]');
    let productData = null;
    
    if (productMeta) {
      try {
        productData = JSON.parse(productMeta.textContent);
      } catch (e) {}
    }
    
    if (!productData && window.ShopifyAnalytics && window.ShopifyAnalytics.meta) {
      productData = window.ShopifyAnalytics.meta.product;
    }
    
    checkMetafieldsAndInit();
  }
  
  function checkMetafieldsAndInit() {
    const metaTags = document.querySelectorAll('meta[property^="product:"]');
    
    let appUrl = null;
    let productTypeId = null;
    let displayName = null;
    let description = null;
    let hideAddToCart = false;
    let enabled = false;
    
    const metaAppUrl = document.querySelector('meta[name="ai_art_studio:app_url"]');
    const metaProductTypeId = document.querySelector('meta[name="ai_art_studio:product_type_id"]');
    const metaEnabled = document.querySelector('meta[name="ai_art_studio:enable"]');
    const metaHideCart = document.querySelector('meta[name="ai_art_studio:hide_add_to_cart"]');
    const metaDisplayName = document.querySelector('meta[name="ai_art_studio:display_name"]');
    const metaDescription = document.querySelector('meta[name="ai_art_studio:description"]');
    
    if (metaAppUrl) appUrl = metaAppUrl.content;
    if (metaProductTypeId) productTypeId = metaProductTypeId.content;
    if (metaEnabled) enabled = metaEnabled.content === 'true';
    if (metaHideCart) hideAddToCart = metaHideCart.content === 'true';
    if (metaDisplayName) displayName = metaDisplayName.content;
    if (metaDescription) description = metaDescription.content;
    
    if (!appUrl || !productTypeId) {
      const scriptData = document.querySelector('[data-ai-art-studio]');
      console.log('[AI Art Embed] Looking for script data, found:', !!scriptData);
      if (scriptData) {
        try {
          const data = JSON.parse(scriptData.textContent);
          console.log('[AI Art Embed] Parsed metafield data:', JSON.stringify(data));
          appUrl = data.appUrl;
          productTypeId = data.productTypeId;
          displayName = data.displayName;
          description = data.description;
          hideAddToCart = data.hideAddToCart === true || data.hideAddToCart === 'true';
          enabled = data.enabled === true || data.enabled === 'true';
        } catch (e) {
          console.error('[AI Art Embed] Failed to parse script data:', e);
        }
      }
    }

    // productTypeId is now optional - backend will auto-resolve using productHandle/displayName
    if (!productTypeId) {
      productTypeId = '0';
      console.log('[AI Art Embed] No productTypeId set - will use backend auto-resolution');
    }

    console.log('[AI Art Embed] Final values - appUrl:', appUrl, 'productTypeId:', productTypeId, 'enabled:', enabled);

    // Inject preconnect hints as early as possible so the browser can start the
    // TCP handshake to Railway before the iframe src is set. This reduces perceived
    // cold-start latency without making an HTTP request that can visibly fail.
    if (appUrl) {
      try {
        var appOriginHint = new URL(appUrl).origin;
        if (!document.querySelector('link[rel="preconnect"][href="' + appOriginHint + '"]')) {
          var pcLink = document.createElement('link');
          pcLink.rel = 'preconnect';
          pcLink.href = appOriginHint;
          pcLink.crossOrigin = 'anonymous';
          document.head.appendChild(pcLink);
          var dnsPrefetch = document.createElement('link');
          dnsPrefetch.rel = 'dns-prefetch';
          dnsPrefetch.href = appOriginHint;
          document.head.appendChild(dnsPrefetch);
        }
      } catch(e) {}
    }

    if (!appUrl) {
      console.log('[AI Art Embed] Missing appUrl, stopping');
      return;
    }

    // Only proceed if the product is enabled for AI Art Studio
    if (!enabled) {
      return;
    }
    
    if (hideAddToCart) {
      hideNativeAddToCart();
      
      const observer = new MutationObserver(() => {
        hideNativeAddToCart();
      });
      if (document.body) {
        observer.observe(document.body, { childList: true, subtree: true });
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          if (document.body) observer.observe(document.body, { childList: true, subtree: true });
        });
      }
    }
    
    const productHandle = window.location.pathname.split('/products/')[1]?.split('?')[0]?.split('#')[0] || '';
    const productTitle = document.querySelector('h1')?.textContent?.trim() || 'Product';
    const productId = window.ShopifyAnalytics?.meta?.product?.id || '';
    
    // Get the currently selected variant from Shopify using multiple detection methods
    let selectedVariant = window.ShopifyAnalytics?.meta?.selectedVariantId || 
                          document.querySelector('[name="id"]')?.value ||
                          document.querySelector('select[name="id"] option:checked')?.value ||
                          document.querySelector('input[name="id"]')?.value ||
                          '';
    
    // Try to get from product JSON in script tag
    if (!selectedVariant) {
      const productJson = document.querySelector('[data-product-json]');
      if (productJson) {
        try {
          const product = JSON.parse(productJson.textContent);
          if (product.variants && product.variants.length > 0) {
            selectedVariant = product.variants[0].id?.toString() || '';
            console.log('[AI Art Embed] Got variant from product JSON:', selectedVariant);
          }
        } catch (e) {
          console.log('[AI Art Embed] Failed to parse product JSON:', e);
        }
      }
    }
    
    // Last resort: fetch product JSON from API
    const initWithVariant = (variantId) => {
      const config = {
        appUrl: appUrl,
        productTypeId: productTypeId,
        productId: productId,
        productHandle: productHandle,
        productTitle: productTitle,
        displayName: displayName || productTitle.replace('Custom ', ''),
        description: description,
        shopDomain: window.Shopify?.shop || window.location.hostname,
        selectedVariant: variantId
      };
      
      console.log('[AI Art Embed] Creating studio with variant:', variantId);
      const studioElement = createDesignStudio(config);

      const doInsert = () => {
        createPlaceholderGallery();
        insertStudioAfterProductInfo(studioElement);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', doInsert);
      } else {
        doInsert();
      }
    };
    
    if (selectedVariant) {
      initWithVariant(selectedVariant);
    } else if (productHandle) {
      // Fetch product JSON as last resort
      fetch('/products/' + productHandle + '.json')
        .then(r => r.json())
        .then(data => {
          const variantId = data.product?.variants?.[0]?.id?.toString() || '';
          console.log('[AI Art Embed] Got variant from API:', variantId);
          initWithVariant(variantId);
        })
        .catch(e => {
          console.log('[AI Art Embed] Failed to fetch product JSON:', e);
          initWithVariant('');
        });
    } else {
      initWithVariant('');
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<style>
.ai-art-studio-embed {
  padding: 2rem 0;
  margin: 2rem 0;
}

.ai-art-studio-embed__wrapper {
  max-width: 100%;
}

.ai-art-studio-embed__heading {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  text-align: center;
}

.ai-art-studio-embed__description {
  color: #666;
  text-align: center;
  margin-bottom: 1.5rem;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

.ai-art-studio-embed__studio {
  width: 100%;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  overflow: hidden;
  background: #fafafa;
  position: relative;
}

.ai-art-studio-embed__loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.ai-art-studio-embed__spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #e5e5e5;
  border-top-color: #333;
  border-radius: 50%;
  animation: ai-art-embed-spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes ai-art-embed-spin {
  to { transform: rotate(360deg); }
}

/* Parent-side Add to Cart button */
.ai-art-atc-btn {
  display: block;
  width: 100%;
  padding: 14px 20px;
  background: #000;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s, background 0.2s;
  letter-spacing: 0.01em;
}
.ai-art-atc-btn:hover:not(:disabled) {
  opacity: 0.88;
}
.ai-art-atc-btn:disabled {
  cursor: not-allowed;
}

/* Artwork Generating spinner inside placeholder gallery */
@keyframes ai-art-spin {
  to { transform: rotate(360deg); }
}
.ai-art-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #ddd;
  border-top-color: #555;
  border-radius: 50%;
  animation: ai-art-spin 0.75s linear infinite;
}
</style>

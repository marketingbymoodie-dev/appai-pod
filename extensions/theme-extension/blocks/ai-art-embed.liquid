{% comment %}
  AI Art Studio - App Embed Script
  This script runs on ALL pages and automatically:
  1. Detects products with ai_art_studio.enable metafield
  2. Injects the AI design studio
  3. Hides the native add-to-cart button when configured
  
  No manual theme configuration required - just publish products from the admin!
{% endcomment %}

{% schema %}
{
  "name": "AI Art Studio",
  "target": "body",
  "settings": []
}
{% endschema %}
<div
  id="appai-root"
  data-shop="{{ shop.permanent_domain }}"
  data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
  style="display:none;"
></div>

{% comment %} Output product metafields as JSON for JavaScript to read {% endcomment %}
{% if product and product.metafields.ai_art_studio.app_url %}
<script type="application/json" data-ai-art-studio>
{
  "appUrl": {{ product.metafields.ai_art_studio.app_url.value | json }},
  "productTypeId": {{ product.metafields.ai_art_studio.product_type_id.value | default: "" | json }},
  "displayName": {{ product.metafields.ai_art_studio.display_name.value | default: product.title | json }},
  "description": {{ product.metafields.ai_art_studio.description.value | default: "" | json }},
  "hideAddToCart": {{ product.metafields.ai_art_studio.hide_add_to_cart.value | default: false | json }},
  "enabled": {{ product.metafields.ai_art_studio.enable.value | default: false | json }}
}
</script>
{% endif %}

<script>
function showLoginRequiredPopup() {
  const overlay = document.createElement("div");
  overlay.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    display: flex; align-items: center; justify-content: center;
    z-index: 999999;
  `;

  const card = document.createElement("div");
  card.style.cssText = `
    width: min(520px, 92vw);
    background: #fff;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,.25);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  `;

  card.innerHTML = `
    <div style="font-size:18px;font-weight:700;margin-bottom:8px;">
      Log in to generate artwork
    </div>
    <div style="font-size:14px;line-height:1.45;color:#333;margin-bottom:12px;">
      We require login so your artwork is automatically saved to your gallery,
      generation limits are applied fairly, and purchase credits can be refunded.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="appai-close" style="
        border:1px solid #ddd;
        background:#fff;
        padding:10px 14px;
        border-radius:10px;
        cursor:pointer;
      ">Not now</button>
      <a href="/account/login" style="
        background:#111;
        color:#fff;
        text-decoration:none;
        padding:10px 14px;
        border-radius:10px;
      ">Log in</a>
    </div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  overlay.querySelector("#appai-close")?.addEventListener("click", () => {
    overlay.remove();
  });
}

(function () {
  'use strict';

  console.log('[AI Art Embed] Script starting...');

  // --- LOGIN GATE (required to generate art) ---
 const customerId = {% if customer %}{{ customer.id | json }}{% else %}null{% endif %}; // always valid JS


  const isProductPageGate =
    window.location.pathname.includes('/products/') ||
    window.location.pathname.includes('/products_preview');

  if (isProductPageGate && !customerId) {
    console.log('[AI Art Embed] No customer logged in -> showing login popup and stopping.');
    showLoginRequiredPopup();
    return; // â›” stop everything below
  }
  // --- END LOGIN GATE ---




  // Cart page handling - load cart script to replace images with mockups
  var isCartPage = window.location.pathname.includes('/cart');
  if (isCartPage) {
    console.log('[AI Art Studio Cart] Loading cart image replacement script...');
    loadCartScript();
  }
  
  // Cart script loader function
  function loadCartScript() {
    // Inline cart image replacement logic
    var cartData = null;
    var isUpdating = false;

    function fetchCartData() {
      return fetch('/cart.js', { headers: { 'Accept': 'application/json' } })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to fetch cart');
          return response.json();
        })
        .then(function(data) {
          cartData = data;
          console.log('[AI Art Studio Cart] Cart data fetched:', (cartData.items && cartData.items.length) || 0, 'items');
          return cartData;
        })
        .catch(function(error) {
          console.error('[AI Art Studio Cart] Error fetching cart:', error);
          return null;
        });
    }

    function getMockupUrl(item) {
      if (!item || !item.properties) return null;
      return item.properties['_mockup_url'] || item.properties['mockup_url'] || null;
    }

    function findCartElements() {
      var selectors = [
        '[data-cart-item]', '.cart-item', '.cart__item', '[class*="cart-item"]',
        'tr[data-variant-id]', 'tr.cart__row', '.line-item', '[data-line-item]'
      ];
      var items = [];
      selectors.forEach(function(sel) {
        try {
          document.querySelectorAll(sel).forEach(function(el) {
            if (items.indexOf(el) === -1) items.push(el);
          });
        } catch(e) {}
      });
      return items;
    }

    function replaceImage(element, mockupUrl) {
      var imgs = element.querySelectorAll('img');
      var replaced = false;
      imgs.forEach(function(img) {
        if (img.dataset.aiMockupApplied === 'true' && img.src === mockupUrl) return;
        if (!img.dataset.originalSrc) img.dataset.originalSrc = img.src;
        img.src = mockupUrl;
        img.srcset = '';
        img.dataset.aiMockupApplied = 'true';
        replaced = true;
        console.log('[AI Art Studio Cart] Replaced image with mockup');
      });
      return replaced;
    }

    function replaceCartImages() {
      if (isUpdating) return;
      isUpdating = true;
      
      fetchCartData().then(function() {
        if (!cartData || !cartData.items || !cartData.items.length) {
          console.log('[AI Art Studio Cart] No cart items');
          isUpdating = false;
          return;
        }
        
        var hasAnyMockups = cartData.items.some(function(item) { return getMockupUrl(item); });
        if (!hasAnyMockups) {
          console.log('[AI Art Studio Cart] No mockup URLs in cart');
          isUpdating = false;
          return;
        }
        
        var elements = findCartElements();
        console.log('[AI Art Studio Cart] Found', elements.length, 'cart elements');
        
        // Direct position matching since we can't reliably match by variant ID
        cartData.items.forEach(function(item, index) {
          var mockupUrl = getMockupUrl(item);
          if (mockupUrl && elements[index]) {
            replaceImage(elements[index], mockupUrl);
          }
        });
        
        isUpdating = false;
      });
    }

    // Run on page load
    setTimeout(replaceCartImages, 500);
    
    // Watch for DOM changes
    var observer = new MutationObserver(function(mutations) {
      var shouldUpdate = mutations.some(function(m) { return m.addedNodes.length > 0; });
      if (shouldUpdate) setTimeout(replaceCartImages, 300);
    });
    
    var container = document.querySelector('[data-cart], .cart, #cart, main');
    if (container) observer.observe(container, { childList: true, subtree: true });
    
    // Listen for cart events
    document.addEventListener('cart:updated', function() { setTimeout(replaceCartImages, 300); });
  }
  
  // Only run product page logic on product pages
  var isProductPage = window.location.pathname.includes('/products/') || 
                      window.location.pathname.includes('/products_preview');
  
  if (!isProductPage) {
    console.log('[AI Art Embed] Not a product page, skipping product logic. Path:', window.location.pathname);
    return;
  }
  console.log('[AI Art Embed] On product page, continuing...');
  
  // Set up GLOBAL message listener for mockups - runs regardless of how embed was added
  console.log('[AI Art Embed] Setting up global message listener...');
  window.addEventListener('message', function(event) {
    // Only process our message types
    if (!event.data || !event.data.type) return;
    
    // Log messages from our app
    if (event.data.type === 'AI_ART_STUDIO_MOCKUPS' || 
        (event.data.type && event.data.type.indexOf('ai-art-studio') !== -1)) {
      console.log('[AI Art Embed] Global listener received:', event.data.type, 'from:', event.origin);
    }
    
    // Handle mockup updates from Railway app origin
    if (event.data.type === 'AI_ART_STUDIO_MOCKUPS') {
      // Security: only accept from Railway origins
      if (event.origin.indexOf('railway.app') === -1) {
        console.log('[AI Art Embed] Ignoring mockups from non-Railway origin:', event.origin);
        return;
      }
      
      var mockupUrls = event.data.mockupUrls;
      if (!mockupUrls || mockupUrls.length === 0) {
        console.log('[AI Art Embed] No mockup URLs in message');
        return;
      }
      
      console.log('[AI Art Embed] Processing', mockupUrls.length, 'mockups - creating custom gallery');
      
      // Find and hide Shopify's native product gallery
      var nativeGallerySelectors = [
        '.product__media-wrapper',
        '.product__media-gallery',
        '.product-single__photos',
        '.product__images',
        '.product-gallery',
        '[data-product-media-container]'
      ];
      
      var nativeGallery = null;
      for (var i = 0; i < nativeGallerySelectors.length; i++) {
        nativeGallery = document.querySelector(nativeGallerySelectors[i]);
        if (nativeGallery) {
          console.log('[AI Art Embed] Found native gallery with:', nativeGallerySelectors[i]);
          nativeGallery.style.display = 'none';
          break;
        }
      }
      
      // Create or update our custom gallery
      var customGallery = document.getElementById('ai-art-custom-gallery');
      if (!customGallery) {
        customGallery = document.createElement('div');
        customGallery.id = 'ai-art-custom-gallery';
        customGallery.style.cssText = 'width:100%;max-width:600px;margin-bottom:20px;';
        
        // Main image container
        var mainImageContainer = document.createElement('div');
        mainImageContainer.id = 'ai-art-main-image';
        mainImageContainer.style.cssText = 'width:100%;aspect-ratio:1;background:#f5f5f5;border-radius:8px;overflow:hidden;margin-bottom:12px;';
        
        var mainImg = document.createElement('img');
        mainImg.id = 'ai-art-main-img';
        mainImg.style.cssText = 'width:100%;height:100%;object-fit:contain;';
        mainImg.alt = 'Your custom design mockup';
        mainImageContainer.appendChild(mainImg);
        customGallery.appendChild(mainImageContainer);
        
        // Thumbnails container
        var thumbsContainer = document.createElement('div');
        thumbsContainer.id = 'ai-art-thumbs';
        thumbsContainer.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;';
        customGallery.appendChild(thumbsContainer);
        
        // Insert before the hidden native gallery or at top of product area
        if (nativeGallery && nativeGallery.parentNode) {
          nativeGallery.parentNode.insertBefore(customGallery, nativeGallery);
        } else {
          var productArea = document.querySelector('.product') || 
                           document.querySelector('[data-product]') ||
                           document.querySelector('main');
          if (productArea) {
            productArea.insertBefore(customGallery, productArea.firstChild);
          }
        }
        console.log('[AI Art Embed] Created custom gallery');
      }
      
      // Update main image
      var mainImg = document.getElementById('ai-art-main-img');
      if (mainImg) {
        mainImg.src = mockupUrls[0];
        console.log('[AI Art Embed] Set main image to first mockup');
      }
      
      // Update thumbnails
      var thumbsContainer = document.getElementById('ai-art-thumbs');
      if (thumbsContainer) {
        thumbsContainer.innerHTML = '';
        
        mockupUrls.forEach(function(url, index) {
          var thumb = document.createElement('div');
          thumb.className = 'ai-art-thumb';
          thumb.style.cssText = 'width:70px;height:70px;cursor:pointer;border:2px solid ' + (index === 0 ? '#000' : '#ddd') + ';border-radius:6px;overflow:hidden;transition:border-color 0.2s;';
          
          var thumbImg = document.createElement('img');
          thumbImg.src = url;
          thumbImg.alt = 'View ' + (index + 1);
          thumbImg.style.cssText = 'width:100%;height:100%;object-fit:cover;';
          thumb.appendChild(thumbImg);
          
          thumb.onclick = function() {
            // Update main image
            if (mainImg) mainImg.src = url;
            
            // Update thumbnail borders
            var allThumbs = thumbsContainer.querySelectorAll('.ai-art-thumb');
            allThumbs.forEach(function(t) { t.style.borderColor = '#ddd'; });
            thumb.style.borderColor = '#000';
            
            console.log('[AI Art Embed] Selected mockup', index + 1);
          };
          
          thumbsContainer.appendChild(thumb);
        });
        
        console.log('[AI Art Embed] Added', mockupUrls.length, 'thumbnails below main image');
      }
      
    }
  });
  
  // Skip if already initialized
  if (document.getElementById('ai-art-studio-auto-embed')) {
    console.log('[AI Art Embed] Already initialized, skipping');
    return;
  }

  // Skip if there's already an iframe from body_html (legacy products)
  var existingIframe = document.querySelector('#ai-art-studio-container iframe, iframe[title="AI Design Studio"]');
  if (existingIframe) {
    console.log('[AI Art Embed] Found existing iframe in body_html, skipping auto-embed');
    return;
  }

  function hideNativeAddToCart() {
    const selectors = [
      'form[action="/cart/add"]',
      '.product-form__submit',
      '.product-form__buttons',
      '[data-add-to-cart]',
      '.add-to-cart',
      '#AddToCart',
      '.shopify-payment-button',
      '.product__submit',
      'button[name="add"]',
      '.product-form__cart-submit'
    ];
    
    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => {
        if (!el.closest('.ai-art-studio-embed')) {
          el.style.display = 'none';
        }
      });
    });
    
    const productForms = document.querySelectorAll('form[action*="/cart/add"]');
    productForms.forEach(form => {
      if (!form.closest('.ai-art-studio-embed')) {
        form.style.display = 'none';
      }
    });
  }
  
  function createDesignStudio(config) {
    const container = document.createElement('div');
    container.className = 'ai-art-studio-embed';
    container.id = 'ai-art-studio-auto-embed';
    
    container.innerHTML = `
      <div class="ai-art-studio-embed__wrapper">
        <h2 class="ai-art-studio-embed__heading">Create Your Custom Design</h2>
        <p class="ai-art-studio-embed__description">${config.description || 'Use AI to generate a unique artwork. Describe your vision and our AI will bring it to life.'}</p>
        <div class="ai-art-studio-embed__studio" style="height: 600px;">
          <div class="ai-art-studio-embed__loading">
            <div class="ai-art-studio-embed__spinner"></div>
            <p>Loading design studio...</p>
          </div>
        </div>
      </div>
    `;
    
    const studioContainer = container.querySelector('.ai-art-studio-embed__studio');
    
    const params = new URLSearchParams();
    params.set('storefront', 'true');  // IMPORTANT: Use storefront=true, NOT embedded=true
    params.set('shopify', 'true');
    params.set('shop', config.shopDomain);
    params.set('productTypeId', config.productTypeId);
    params.set('productId', config.productId);
    params.set('productHandle', config.productHandle);
    params.set('productTitle', config.productTitle);
    params.set('displayName', config.displayName);
    params.set('showPresets', 'true');
    if (config.selectedVariant) {
      params.set('selectedVariant', config.selectedVariant);
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedDesignId = urlParams.get('sharedDesignId');
    if (sharedDesignId) {
      params.set('sharedDesignId', sharedDesignId);
    }
    
    const iframe = document.createElement('iframe');
    iframe.src = `${config.appUrl}/embed/design?${params.toString()}`;
    iframe.allow = 'clipboard-write';
    iframe.title = 'AI Art Design Studio';
    iframe.style.cssText = 'width: 100%; height: 100%; border: none;';
    
    iframe.onload = function() {
      const loading = studioContainer.querySelector('.ai-art-studio-embed__loading');
      if (loading) loading.remove();
    };
    
    studioContainer.appendChild(iframe);
    
    console.log('[AI Art Embed] Setting up message listener for origin:', config.appUrl);
    
    window.addEventListener('message', function(event) {
      // Log all messages from our app
      if (event.data && event.data.type && (event.data.type.indexOf('art-studio') !== -1 || event.data.type === 'AI_ART_STUDIO_MOCKUPS')) {
        console.log('[AI Art Embed] Received message:', event.data.type, 'from:', event.origin);
      }
      
      try {
        const appOrigin = new URL(config.appUrl).origin;
        // Accept messages from the configured app origin (Railway)
        if (event.origin !== appOrigin) {
          console.log('[AI Art Embed] Origin mismatch:', event.origin, 'vs', appOrigin);
          return;
        }
      } catch (e) {
        console.log('[AI Art Embed] Error parsing origin:', e);
        return;
      }
      
      const data = event.data;
      
      if (data.type === 'ai-art-studio:add-to-cart') {
        console.log('[AI Art Embed] Adding to cart:', {
          variantId: data.variantId,
          artworkUrl: data.artworkUrl,
          designId: data.designId
        });
        
        const formData = {
          items: [{
            id: data.variantId,
            quantity: 1,
            properties: {
              '_artwork_url': data.artworkUrl,
              '_design_id': data.designId,
              'Artwork': 'Custom AI Design'
            }
          }]
        };
        
        console.log('[AI Art Embed] Sending cart request to /cart/add.js');
        
        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
        .then(response => {
          console.log('[AI Art Embed] Cart response status:', response.status);
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error('Cart error (' + response.status + '): ' + text);
            });
          }
          return response.json();
        })
        .then(result => {
          console.log('[AI Art Embed] Cart success:', result);
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: true,
            cart: result
          }, config.appUrl);
          
          document.dispatchEvent(new CustomEvent('cart:refresh'));
          
          // Also try to update cart drawer/icon count
          if (window.Shopify && window.Shopify.theme && window.Shopify.theme.sections) {
            document.dispatchEvent(new CustomEvent('shopify:section:rerender'));
          }
        })
        .catch(error => {
          console.error('[AI Art Embed] Failed to add to cart:', error);
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: false,
            error: error.message
          }, config.appUrl);
        });
      }
      
      if (data.type === 'ai-art-studio:resize') {
        studioContainer.style.height = data.height + 'px';
      }
      
      // Handle mockup updates - create preview section
      if (data.type === 'AI_ART_STUDIO_MOCKUPS') {
        var mockupUrls = data.mockupUrls;
        if (!mockupUrls || mockupUrls.length === 0) return;
        
        console.log('[AI Art Embed] Received mockups:', mockupUrls.length);
        
        var previewSection = document.getElementById('ai-art-mockup-preview');
        if (!previewSection) {
          previewSection = document.createElement('div');
          previewSection.id = 'ai-art-mockup-preview';
          previewSection.style.cssText = 'display:block;margin-bottom:2rem;padding:1.5rem;background:#fff;border:1px solid #e5e5e5;border-radius:8px;';
          previewSection.innerHTML = '<h4 style="font-size:1.25rem;font-weight:600;margin-bottom:1rem;text-align:center;color:#333;">Your Custom Design Preview</h4><div id="ai-art-mockup-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;max-width:800px;margin:0 auto;"></div>';
          
          var studioWrapper = container.closest('.ai-art-studio-embed');
          if (studioWrapper && studioWrapper.parentNode) {
            studioWrapper.parentNode.insertBefore(previewSection, studioWrapper);
          } else {
            container.parentNode.insertBefore(previewSection, container);
          }
        }
        
        var grid = document.getElementById('ai-art-mockup-grid');
        if (grid) {
          grid.innerHTML = '';
          mockupUrls.forEach(function(url) {
            var item = document.createElement('div');
            item.style.cssText = 'aspect-ratio:1;overflow:hidden;border-radius:6px;border:1px solid #e5e5e5;background:#fafafa;';
            var img = document.createElement('img');
            img.src = url;
            img.alt = 'Product mockup with custom design';
            img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
            item.appendChild(img);
            grid.appendChild(item);
          });
        }
        
        console.log('[AI Art Embed] Mockup preview updated');
      }
    });
    
    return container;
  }
  
  function insertStudioAfterProductInfo(studioElement) {
    const insertionPoints = [
      '.product__info-wrapper',
      '.product-single__meta',
      '.product__content',
      '.product-info',
      '[data-product-info]',
      '.product__description',
      '.product-description'
    ];
    
    for (const selector of insertionPoints) {
      const target = document.querySelector(selector);
      if (target) {
        target.parentNode.insertBefore(studioElement, target.nextSibling);
        return true;
      }
    }
    
    const productContainer = document.querySelector('.product, [data-product], .product-template, main');
    if (productContainer) {
      productContainer.appendChild(studioElement);
      return true;
    }
    
    return false;
  }
  
  function init() {
    var isProductPage = window.location.pathname.includes('/products/') || 
                        window.location.pathname.includes('/products_preview');
    if (!isProductPage) {
      return;
    }
    
    if (document.getElementById('ai-art-studio-auto-embed')) {
      return;
    }
    
    const productMeta = document.querySelector('[data-product-json]');
    let productData = null;
    
    if (productMeta) {
      try {
        productData = JSON.parse(productMeta.textContent);
      } catch (e) {}
    }
    
    if (!productData && window.ShopifyAnalytics && window.ShopifyAnalytics.meta) {
      productData = window.ShopifyAnalytics.meta.product;
    }
    
    checkMetafieldsAndInit();
  }
  
  function checkMetafieldsAndInit() {
    const metaTags = document.querySelectorAll('meta[property^="product:"]');
    
    let appUrl = null;
    let productTypeId = null;
    let displayName = null;
    let description = null;
    let hideAddToCart = false;
    let enabled = false;
    
    const metaAppUrl = document.querySelector('meta[name="ai_art_studio:app_url"]');
    const metaProductTypeId = document.querySelector('meta[name="ai_art_studio:product_type_id"]');
    const metaEnabled = document.querySelector('meta[name="ai_art_studio:enable"]');
    const metaHideCart = document.querySelector('meta[name="ai_art_studio:hide_add_to_cart"]');
    const metaDisplayName = document.querySelector('meta[name="ai_art_studio:display_name"]');
    const metaDescription = document.querySelector('meta[name="ai_art_studio:description"]');
    
    if (metaAppUrl) appUrl = metaAppUrl.content;
    if (metaProductTypeId) productTypeId = metaProductTypeId.content;
    if (metaEnabled) enabled = metaEnabled.content === 'true';
    if (metaHideCart) hideAddToCart = metaHideCart.content === 'true';
    if (metaDisplayName) displayName = metaDisplayName.content;
    if (metaDescription) description = metaDescription.content;
    
    if (!appUrl || !productTypeId) {
      const scriptData = document.querySelector('[data-ai-art-studio]');
      console.log('[AI Art Embed] Looking for script data, found:', !!scriptData);
      if (scriptData) {
        try {
          const data = JSON.parse(scriptData.textContent);
          console.log('[AI Art Embed] Parsed metafield data:', JSON.stringify(data));
          appUrl = data.appUrl;
          productTypeId = data.productTypeId;
          displayName = data.displayName;
          description = data.description;
          hideAddToCart = data.hideAddToCart === true || data.hideAddToCart === 'true';
          enabled = data.enabled === true || data.enabled === 'true';
        } catch (e) {
          console.error('[AI Art Embed] Failed to parse script data:', e);
        }
      }
    }

    console.log('[AI Art Embed] Final values - appUrl:', appUrl, 'productTypeId:', productTypeId, 'enabled:', enabled);

    if (!appUrl || !productTypeId) {
      console.log('[AI Art Embed] Missing appUrl or productTypeId, stopping');
      return;
    }
    
    // Only proceed if the product is enabled for AI Art Studio
    if (!enabled) {
      return;
    }
    
    if (hideAddToCart) {
      hideNativeAddToCart();
      
      const observer = new MutationObserver(() => {
        hideNativeAddToCart();
      });
      observer.observe(document.body, { childList: true, subtree: true });
    }
    
    const productHandle = window.location.pathname.split('/products/')[1]?.split('?')[0]?.split('#')[0] || '';
    const productTitle = document.querySelector('h1')?.textContent?.trim() || 'Product';
    const productId = window.ShopifyAnalytics?.meta?.product?.id || '';
    
    // Get the currently selected variant from Shopify using multiple detection methods
    let selectedVariant = window.ShopifyAnalytics?.meta?.selectedVariantId || 
                          document.querySelector('[name="id"]')?.value ||
                          document.querySelector('select[name="id"] option:checked')?.value ||
                          document.querySelector('input[name="id"]')?.value ||
                          '';
    
    // Try to get from product JSON in script tag
    if (!selectedVariant) {
      const productJson = document.querySelector('[data-product-json]');
      if (productJson) {
        try {
          const product = JSON.parse(productJson.textContent);
          if (product.variants && product.variants.length > 0) {
            selectedVariant = product.variants[0].id?.toString() || '';
            console.log('[AI Art Embed] Got variant from product JSON:', selectedVariant);
          }
        } catch (e) {
          console.log('[AI Art Embed] Failed to parse product JSON:', e);
        }
      }
    }
    
    // Last resort: fetch product JSON from API
    const initWithVariant = (variantId) => {
      const config = {
        appUrl: appUrl,
        productTypeId: productTypeId,
        productId: productId,
        productHandle: productHandle,
        productTitle: productTitle,
        displayName: displayName || productTitle.replace('Custom ', ''),
        description: description,
        shopDomain: window.Shopify?.shop || window.location.hostname,
        selectedVariant: variantId
      };
      
      console.log('[AI Art Embed] Creating studio with variant:', variantId);
      const studioElement = createDesignStudio(config);
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          insertStudioAfterProductInfo(studioElement);
        });
      } else {
        insertStudioAfterProductInfo(studioElement);
      }
    };
    
    if (selectedVariant) {
      initWithVariant(selectedVariant);
    } else if (productHandle) {
      // Fetch product JSON as last resort
      fetch('/products/' + productHandle + '.json')
        .then(r => r.json())
        .then(data => {
          const variantId = data.product?.variants?.[0]?.id?.toString() || '';
          console.log('[AI Art Embed] Got variant from API:', variantId);
          initWithVariant(variantId);
        })
        .catch(e => {
          console.log('[AI Art Embed] Failed to fetch product JSON:', e);
          initWithVariant('');
        });
    } else {
      initWithVariant('');
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<style>
.ai-art-studio-embed {
  padding: 2rem 0;
  margin: 2rem 0;
}

.ai-art-studio-embed__wrapper {
  max-width: 100%;
}

.ai-art-studio-embed__heading {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  text-align: center;
}

.ai-art-studio-embed__description {
  color: #666;
  text-align: center;
  margin-bottom: 1.5rem;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

.ai-art-studio-embed__studio {
  width: 100%;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  overflow: hidden;
  background: #fafafa;
  position: relative;
}

.ai-art-studio-embed__loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.ai-art-studio-embed__spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #e5e5e5;
  border-top-color: #333;
  border-radius: 50%;
  animation: ai-art-embed-spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes ai-art-embed-spin {
  to { transform: rotate(360deg); }
}
</style>

{% comment %}
  AI Art Studio - Product Page Design Block
  Embeds the AI artwork customization studio directly on product pages.
  
  Configuration priority:
  1. Product metafields (set automatically when publishing from admin)
  2. Block settings (manual fallback)
  
  When products are published via "Send to Store", metafields are automatically
  configured - no manual theme editor setup required.
{% endcomment %}

{% comment %} Read metafields - these are set automatically when publishing from admin {% endcomment %}
{% assign meta_app_url = product.metafields.ai_art_studio.app_url.value %}
{% assign meta_product_type_id = product.metafields.ai_art_studio.product_type_id.value %}
{% assign meta_display_name = product.metafields.ai_art_studio.display_name.value %}
{% assign meta_description = product.metafields.ai_art_studio.description.value %}

{% comment %} Use metafields first, fall back to block settings {% endcomment %}
{% assign app_url = meta_app_url | default: block.settings.app_url %}
{% assign product_type_id = meta_product_type_id | default: block.settings.product_type_id | default: "1" %}
{% assign display_name = meta_display_name | default: product.title | remove: "Custom " %}
{% assign custom_description = meta_description %}

{% comment %} Generate dynamic heading and description if not manually set {% endcomment %}
{% if block.settings.heading != blank and block.settings.heading != "Create Your Custom Design" %}
  {% assign heading = block.settings.heading %}
{% else %}
  {% assign heading = "Create Your Custom " | append: display_name | append: " Design" %}
{% endif %}

{% if block.settings.description != blank and block.settings.description != "Use AI to generate a unique artwork for your product. Describe your vision and our AI will bring it to life." %}
  {% assign description = block.settings.description %}
{% elsif custom_description != blank %}
  {% assign description = custom_description %}
{% else %}
  {% assign description = "Use AI to generate a unique artwork for your " | append: display_name | downcase | append: ". Describe your vision and our AI will bring it to life." %}
{% endif %}

{% schema %}
{
  "name": "AI Art Design Studio",
  "target": "section",
  "settings": [
    {
      "type": "url",
      "id": "app_url",
      "label": "App URL",
      "info": "Leave blank for auto-configured products. Only set manually if needed."
    },
    {
      "type": "text",
      "id": "product_type_id",
      "label": "Product Type ID",
      "info": "Leave blank for auto-configured products. Only set manually if needed."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Create Your Custom Design",
      "info": "Leave as default to use dynamic product name"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Section Description",
      "default": "Use AI to generate a unique artwork for your product. Describe your vision and our AI will bring it to life.",
      "info": "Leave as default to use dynamic product description"
    },
    {
      "type": "checkbox",
      "id": "show_style_presets",
      "label": "Show Style Presets",
      "default": true
    },
    {
      "type": "range",
      "id": "studio_height",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Studio Height",
      "default": 600
    }
  ]
}
{% endschema %}

<div class="ai-art-studio-block" data-block-id="{{ block.id }}">
  {% if heading != blank %}
    <h2 class="ai-art-studio__heading">{{ heading }}</h2>
  {% endif %}
  
  {% if description != blank %}
    <p class="ai-art-studio__description">{{ description }}</p>
  {% endif %}

  <div 
    id="ai-art-studio-container-{{ block.id }}"
    class="ai-art-studio__container"
    data-app-url="{{ app_url }}"
    data-product-type-id="{{ product_type_id }}"
    data-product-id="{{ product.id }}"
    data-product-handle="{{ product.handle }}"
    data-product-title="{{ product.title | escape }}"
    data-display-name="{{ display_name | escape }}"
    data-show-presets="{{ block.settings.show_style_presets }}"
    data-selected-variant="{{ product.selected_or_first_available_variant.id }}"
    data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
    data-customer-email="{% if customer %}{{ customer.email | escape }}{% endif %}"
    data-customer-name="{% if customer %}{{ customer.first_name | escape }}{% endif %}"
    data-shop-domain="{{ shop.permanent_domain }}"
    style="height: {{ block.settings.studio_height }}px;"
  >
    <div class="ai-art-studio__loading">
      <div class="ai-art-studio__spinner"></div>
      <p>Loading design studio...</p>
    </div>
  </div>
  
<script>
    console.log('[AI Art Studio] Inline script test - block id: {{ block.id }}');
    
    (function() {
      var containers = document.querySelectorAll('[id^="ai-art-studio-container-"]');
      console.log('[AI Art Studio] Found containers:', containers.length);
      
      containers.forEach(function(container) {
        var appUrl = container.dataset.appUrl;
        console.log('[AI Art Studio] Container appUrl:', appUrl);
        
        if (!appUrl) {
          container.innerHTML = '<div style="padding:2rem;text-align:center;color:#dc2626;">This product has not been configured for the design studio.</div>';
          return;
        }
        
        var productTypeId = container.dataset.productTypeId || '1';
        var productId = container.dataset.productId;
        var productHandle = container.dataset.productHandle;
        var productTitle = container.dataset.productTitle;
        var displayName = container.dataset.displayName || productTitle;
        var showPresets = container.dataset.showPresets === 'true';
        var selectedVariant = container.dataset.selectedVariant;
        var customerId = container.dataset.customerId || '';
        var customerEmail = container.dataset.customerEmail || '';
        var customerName = container.dataset.customerName || '';
        var shopDomain = container.dataset.shopDomain || (window.Shopify && window.Shopify.shop) || window.location.hostname;
        
        var urlParams = new URLSearchParams(window.location.search);
        var sharedDesignId = urlParams.get('sharedDesignId');
        
        var params = new URLSearchParams();
        params.set('embedded', 'true');
        params.set('shopify', 'true');
        params.set('shop', shopDomain);
        params.set('productTypeId', productTypeId);
        params.set('productId', productId);
        params.set('productHandle', productHandle);
        params.set('productTitle', productTitle);
        params.set('displayName', displayName);
        params.set('showPresets', showPresets.toString());
        params.set('selectedVariant', selectedVariant);
        if (customerId) {
          params.set('customerId', customerId);
          params.set('customerEmail', customerEmail);
          params.set('customerName', customerName);
        }
        if (sharedDesignId) {
          params.set('sharedDesignId', sharedDesignId);
        }
        
        var iframe = document.createElement('iframe');
        iframe.src = appUrl + '/embed/design?' + params.toString();
        iframe.allow = 'clipboard-write';
        iframe.title = 'AI Art Design Studio';
        
        iframe.onload = function() {
          var loading = container.querySelector('.ai-art-studio__loading');
          if (loading) loading.remove();
        };
        
        container.appendChild(iframe);
        
        var expectedOrigin = null;
        try {
          if (appUrl) expectedOrigin = new URL(appUrl).origin;
        } catch (e) {}
        
        var iframeOrigin = null;
        try {
          iframeOrigin = new URL(iframe.src).origin;
        } catch (e) {}
        
        console.log('[AI Art Studio] Message listener ready. Origins:', expectedOrigin, iframeOrigin);
        
        window.addEventListener('message', function(event) {
          var isValidOrigin = (expectedOrigin && event.origin === expectedOrigin) || 
                              (iframeOrigin && event.origin === iframeOrigin) ||
                              (event.origin && event.origin.indexOf('replit') !== -1);
          
          if (!isValidOrigin) return;
          
          var data = event.data;
          if (!data || !data.type) return;
          
          if (data.type === 'AI_ART_STUDIO_MOCKUPS') {
            var mockupUrls = data.mockupUrls;
            if (!mockupUrls || mockupUrls.length === 0) return;
            
            console.log('[AI Art Studio] Received mockup URLs:', mockupUrls.length);
            
            var previewSection = document.querySelector('.ai-art-mockup-preview');
            if (!previewSection) {
              previewSection = document.createElement('div');
              previewSection.className = 'ai-art-mockup-preview';
              previewSection.innerHTML = '<h4 class="ai-art-mockup-preview__title">Your Custom Design Preview</h4><div class="ai-art-mockup-preview__grid"></div>';
              var designBlock = container.closest('.ai-art-studio-block');
              if (designBlock) {
                designBlock.parentNode.insertBefore(previewSection, designBlock);
              }
            }
            
            if (previewSection) {
              previewSection.style.display = 'block';
              var grid = previewSection.querySelector('.ai-art-mockup-preview__grid');
              if (grid) {
                grid.innerHTML = '';
                mockupUrls.forEach(function(url) {
                  var item = document.createElement('div');
                  item.className = 'ai-art-mockup-preview__item';
                  var img = document.createElement('img');
                  img.src = url;
                  img.alt = 'Product mockup with custom design';
                  item.appendChild(img);
                  grid.appendChild(item);
                });
              }
            }
          }
          
          if (data.type === 'ai-art-studio:add-to-cart') {
            fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                items: [{
                  id: data.variantId,
                  quantity: 1,
                  properties: {
                    '_artwork_url': data.artworkUrl,
                    '_design_id': data.designId,
                    'Artwork': 'Custom AI Design'
                  }
                }]
              })
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
              iframe.contentWindow.postMessage({ type: 'ai-art-studio:cart-updated', success: true, cart: result }, appUrl);
              document.dispatchEvent(new CustomEvent('cart:refresh'));
            })
            .catch(function(err) {
              iframe.contentWindow.postMessage({ type: 'ai-art-studio:cart-updated', success: false, error: err.message }, appUrl);
            });
          }
          
          if (data.type === 'ai-art-studio:resize') {
            container.style.height = data.height + 'px';
          }
        });
      });
    })();
  </script>
</div>

<style>
  .ai-art-studio-block {
    padding: 2rem 0;
    margin: 2rem 0;
  }

  .ai-art-studio__heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .ai-art-studio__description {
    color: #666;
    text-align: center;
    margin-bottom: 1.5rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .ai-art-studio__container {
    width: 100%;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
    position: relative;
  }

  .ai-art-studio__container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .ai-art-studio__loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .ai-art-studio__spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e5e5;
    border-top-color: #333;
    border-radius: 50%;
    animation: ai-art-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes ai-art-spin {
    to { transform: rotate(360deg); }
  }

  .ai-art-studio__error {
    padding: 2rem;
    text-align: center;
    color: #dc2626;
  }

  /* Mockup Preview Section - Guaranteed fallback for all themes */
  .ai-art-mockup-preview {
    display: none;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
  }

  .ai-art-mockup-preview__title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    text-align: center;
    color: #333;
  }

  .ai-art-mockup-preview__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    max-width: 800px;
    margin: 0 auto;
  }

  .ai-art-mockup-preview__item {
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 6px;
    border: 1px solid #e5e5e5;
    background: #fafafa;
  }

  .ai-art-mockup-preview__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  @media (min-width: 768px) {
    .ai-art-mockup-preview__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

{% comment %}
  AI Art Studio - Product Page Design Block
  Embeds the AI artwork customization studio directly on product pages.
  
  Configuration priority:
  1. Product metafields (set automatically when publishing from admin)
  2. Block settings (manual fallback)
  
  When products are published via "Send to Store", metafields are automatically
  configured - no manual theme editor setup required.
{% endcomment %}

{% comment %} Read metafields - these are set automatically when publishing from admin {% endcomment %}
{% assign meta_app_url = product.metafields.ai_art_studio.app_url.value %}
{% assign meta_product_type_id = product.metafields.ai_art_studio.product_type_id.value %}
{% assign meta_display_name = product.metafields.ai_art_studio.display_name.value %}
{% assign meta_description = product.metafields.ai_art_studio.description.value %}

{% comment %} Use metafields first, fall back to block settings {% endcomment %}
{% assign app_url = meta_app_url | default: block.settings.app_url %}
{% assign product_type_id = meta_product_type_id | default: block.settings.product_type_id | default: "1" %}
{% assign display_name = meta_display_name | default: product.title | remove: "Custom " %}
{% assign custom_description = meta_description %}

{% comment %} Generate dynamic heading and description if not manually set {% endcomment %}
{% if block.settings.heading != blank and block.settings.heading != "Create Your Custom Design" %}
  {% assign heading = block.settings.heading %}
{% else %}
  {% assign heading = "Create Your Custom " | append: display_name | append: " Design" %}
{% endif %}

{% if block.settings.description != blank and block.settings.description != "Use AI to generate a unique artwork for your product. Describe your vision and our AI will bring it to life." %}
  {% assign description = block.settings.description %}
{% elsif custom_description != blank %}
  {% assign description = custom_description %}
{% else %}
  {% assign description = "Use AI to generate a unique artwork for your " | append: display_name | downcase | append: ". Describe your vision and our AI will bring it to life." %}
{% endif %}

{% schema %}
{
  "name": "AI Art Design Studio",
  "target": "section",
  "settings": [
    {
      "type": "url",
      "id": "app_url",
      "label": "App URL",
      "info": "Leave blank for auto-configured products. Only set manually if needed."
    },
    {
      "type": "text",
      "id": "product_type_id",
      "label": "Product Type ID",
      "info": "Leave blank for auto-configured products. Only set manually if needed."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Create Your Custom Design",
      "info": "Leave as default to use dynamic product name"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Section Description",
      "default": "Use AI to generate a unique artwork for your product. Describe your vision and our AI will bring it to life.",
      "info": "Leave as default to use dynamic product description"
    },
    {
      "type": "checkbox",
      "id": "show_style_presets",
      "label": "Show Style Presets",
      "default": true
    },
    {
      "type": "range",
      "id": "studio_height",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Studio Height",
      "default": 600
    }
  ]
}
{% endschema %}

<div class="ai-art-studio-block" data-block-id="{{ block.id }}">
  {% if heading != blank %}
    <h2 class="ai-art-studio__heading">{{ heading }}</h2>
  {% endif %}
  
  {% if description != blank %}
    <p class="ai-art-studio__description">{{ description }}</p>
  {% endif %}

  <div 
    id="ai-art-studio-container-{{ block.id }}"
    class="ai-art-studio__container"
    data-app-url="{{ app_url }}"
    data-product-type-id="{{ product_type_id }}"
    data-product-id="{{ product.id }}"
    data-product-handle="{{ product.handle }}"
    data-product-title="{{ product.title | escape }}"
    data-display-name="{{ display_name | escape }}"
    data-show-presets="{{ block.settings.show_style_presets }}"
    data-selected-variant="{{ product.selected_or_first_available_variant.id }}"
    data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
    data-customer-email="{% if customer %}{{ customer.email | escape }}{% endif %}"
    data-customer-name="{% if customer %}{{ customer.first_name | escape }}{% endif %}"
    data-shop-domain="{{ shop.permanent_domain }}"
    style="height: {{ block.settings.studio_height }}px;"
  >
    <div class="ai-art-studio__loading">
      <div class="ai-art-studio__spinner"></div>
      <p>Loading design studio...</p>
    </div>
  </div>
</div>

<style>
  .ai-art-studio-block {
    padding: 2rem 0;
    margin: 2rem 0;
  }

  .ai-art-studio__heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .ai-art-studio__description {
    color: #666;
    text-align: center;
    margin-bottom: 1.5rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .ai-art-studio__container {
    width: 100%;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
    position: relative;
  }

  .ai-art-studio__container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .ai-art-studio__loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .ai-art-studio__spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e5e5;
    border-top-color: #333;
    border-radius: 50%;
    animation: ai-art-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes ai-art-spin {
    to { transform: rotate(360deg); }
  }

  .ai-art-studio__error {
    padding: 2rem;
    text-align: center;
    color: #dc2626;
  }
</style>

<script>
  (function() {
    const container = document.getElementById('ai-art-studio-container-{{ block.id }}');
    if (!container) return;

    const appUrl = container.dataset.appUrl;
    if (!appUrl) {
      container.innerHTML = '<div class="ai-art-studio__error">This product has not been configured for the design studio. Please publish it from the AI Art Studio admin.</div>';
      return;
    }

    const productTypeId = container.dataset.productTypeId || '1';
    const productId = container.dataset.productId;
    const productHandle = container.dataset.productHandle;
    const productTitle = container.dataset.productTitle;
    const displayName = container.dataset.displayName || productTitle;
    const showPresets = container.dataset.showPresets === 'true';
    const selectedVariant = container.dataset.selectedVariant;
    const customerId = container.dataset.customerId || '';
    const customerEmail = container.dataset.customerEmail || '';
    const customerName = container.dataset.customerName || '';
    
    const shopDomain = container.dataset.shopDomain || window.Shopify?.shop || window.location.hostname;
    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedDesignId = urlParams.get('sharedDesignId');
    
    const params = new URLSearchParams();
    params.set('embedded', 'true');
    params.set('shopify', 'true');
    params.set('shop', shopDomain);
    params.set('productTypeId', productTypeId);
    params.set('productId', productId);
    params.set('productHandle', productHandle);
    params.set('productTitle', productTitle);
    params.set('displayName', displayName);
    params.set('showPresets', showPresets.toString());
    params.set('selectedVariant', selectedVariant);
    if (customerId) {
      params.set('customerId', customerId);
      params.set('customerEmail', customerEmail);
      params.set('customerName', customerName);
    }
    if (sharedDesignId) {
      params.set('sharedDesignId', sharedDesignId);
    }

    const iframe = document.createElement('iframe');
    iframe.src = `${appUrl}/embed/design?${params.toString()}`;
    iframe.allow = 'clipboard-write';
    iframe.title = 'AI Art Design Studio';

    iframe.onload = function() {
      const loading = container.querySelector('.ai-art-studio__loading');
      if (loading) loading.remove();
    };

    container.appendChild(iframe);

    window.addEventListener('message', function(event) {
      if (event.origin !== new URL(appUrl).origin) return;

      const data = event.data;
      
      if (data.type === 'ai-art-studio:add-to-cart') {
        const variantId = data.variantId;
        const artworkUrl = data.artworkUrl;
        const designId = data.designId;

        const formData = {
          items: [{
            id: variantId,
            quantity: 1,
            properties: {
              '_artwork_url': artworkUrl,
              '_design_id': designId,
              'Artwork': 'Custom AI Design'
            }
          }]
        };

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(result => {
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: true,
            cart: result
          }, appUrl);
          
          document.dispatchEvent(new CustomEvent('cart:refresh'));
          
          if (window.location.pathname !== '/cart') {
            const cartDrawer = document.querySelector('[data-cart-drawer]');
            if (cartDrawer) {
              cartDrawer.classList.add('is-active');
            }
          }
        })
        .catch(error => {
          console.error('Failed to add to cart:', error);
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: false,
            error: error.message
          }, appUrl);
        });
      }

      if (data.type === 'ai-art-studio:resize') {
        container.style.height = data.height + 'px';
      }

      // Handle mockup updates from the AI generator
      if (data.type === 'AI_ART_STUDIO_MOCKUPS') {
        const mockupUrls = data.mockupUrls;
        if (!mockupUrls || mockupUrls.length === 0) return;
        
        console.log('[AI Art Studio] Received mockup URLs:', mockupUrls.length);
        
        // Find the product gallery/media container
        // Common selectors for Shopify themes
        const gallerySelectors = [
          '.product__media-list',
          '.product-gallery',
          '[data-product-media-container]',
          '.product-media-container',
          '.product__images',
          '.product-images',
          '.product-single__photos',
          '.product__photos',
          '[data-product-images]',
          '.product-featured-media',
          '.product__main-photos'
        ];
        
        let gallery = null;
        for (const selector of gallerySelectors) {
          gallery = document.querySelector(selector);
          if (gallery) break;
        }
        
        // Also try to find individual product images
        const imageSelectors = [
          '.product__media-item img',
          '.product-gallery__image',
          '.product-single__photo img',
          '.product__photo img',
          '[data-product-featured-image]',
          '.product-featured-media img',
          '.product__main-photos img'
        ];
        
        let productImages = [];
        for (const selector of imageSelectors) {
          productImages = document.querySelectorAll(selector);
          if (productImages.length > 0) break;
        }
        
        // Replace product images with mockups
        if (productImages.length > 0) {
          console.log('[AI Art Studio] Found product images:', productImages.length);
          mockupUrls.forEach((url, index) => {
            if (productImages[index]) {
              const img = productImages[index];
              // Store original src for potential reset
              if (!img.dataset.originalSrc) {
                img.dataset.originalSrc = img.src;
              }
              img.src = url;
              img.srcset = ''; // Clear srcset to prevent override
              
              // Also update any parent picture element sources
              const picture = img.closest('picture');
              if (picture) {
                picture.querySelectorAll('source').forEach(source => {
                  source.srcset = url;
                });
              }
            }
          });
          
          // If we have more mockups than current images and a gallery exists
          if (gallery && mockupUrls.length > productImages.length) {
            for (let i = productImages.length; i < mockupUrls.length; i++) {
              const newImg = document.createElement('img');
              newImg.src = mockupUrls[i];
              newImg.alt = 'AI Generated Design Preview';
              newImg.className = productImages[0]?.className || '';
              newImg.dataset.aiMockup = 'true';
              gallery.appendChild(newImg);
            }
          }
        } else {
          console.log('[AI Art Studio] No product images found to update');
        }
        
        // Also try to update thumbnail images if they exist
        const thumbnailSelectors = [
          '.product__media-toggle',
          '.product-thumbnails img',
          '.product__thumbs img',
          '[data-thumbnail-id] img'
        ];
        
        for (const selector of thumbnailSelectors) {
          const thumbnails = document.querySelectorAll(selector);
          if (thumbnails.length > 0) {
            mockupUrls.forEach((url, index) => {
              if (thumbnails[index]) {
                const thumb = thumbnails[index].tagName === 'IMG' 
                  ? thumbnails[index] 
                  : thumbnails[index].querySelector('img');
                if (thumb) {
                  if (!thumb.dataset.originalSrc) {
                    thumb.dataset.originalSrc = thumb.src;
                  }
                  thumb.src = url;
                  thumb.srcset = '';
                }
              }
            });
            break;
          }
        }
      }
    });
  })();
</script>

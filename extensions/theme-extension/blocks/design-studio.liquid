{% comment %}
  AI Art Studio - Product Page Design Block
  Embeds the AI artwork customization studio directly on product pages.
  
  Configuration priority:
  1. Product metafields (set automatically when publishing from admin)
  2. Block settings (manual fallback)
  
  When products are published via "Send to Store", metafields are automatically
  configured - no manual theme editor setup required.
{% endcomment %}

{% comment %} Read metafields - these are set automatically when publishing from admin {% endcomment %}
{% assign meta_app_url = product.metafields.ai_art_studio.app_url.value %}
{% assign meta_product_type_id = product.metafields.ai_art_studio.product_type_id.value %}
{% assign meta_display_name = product.metafields.ai_art_studio.display_name.value %}
{% assign meta_description = product.metafields.ai_art_studio.description.value %}

{% comment %} Use metafields first, fall back to block settings {% endcomment %}
{% assign app_url = meta_app_url | default: block.settings.app_url %}
{% assign product_type_id = meta_product_type_id | default: block.settings.product_type_id | default: "1" %}
{% assign display_name = meta_display_name | default: product.title | remove: "Custom " %}
{% assign custom_description = meta_description %}

{% comment %} Generate dynamic heading and description if not manually set {% endcomment %}
{% if block.settings.heading != blank and block.settings.heading != "Create Your Custom Design" %}
  {% assign heading = block.settings.heading %}
{% else %}
  {% assign heading = "Create Your Custom " | append: display_name | append: " Design" %}
{% endif %}

{% if block.settings.description != blank and block.settings.description != "Use AI to generate a unique artwork for your product. Describe your vision and our AI will bring it to life." %}
  {% assign description = block.settings.description %}
{% elsif custom_description != blank %}
  {% assign description = custom_description %}
{% else %}
  {% assign description = "Use AI to generate a unique artwork for your " | append: display_name | downcase | append: ". Describe your vision and our AI will bring it to life." %}
{% endif %}

{% schema %}
{
  "name": "AI Art Design Studio",
  "target": "section",
  "settings": [
    {
      "type": "url",
      "id": "app_url",
      "label": "App URL",
      "info": "Leave blank for auto-configured products. Only set manually if needed."
    },
    {
      "type": "text",
      "id": "product_type_id",
      "label": "Product Type ID",
      "info": "Leave blank for auto-configured products. Only set manually if needed."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Create Your Custom Design",
      "info": "Leave as default to use dynamic product name"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Section Description",
      "default": "Use AI to generate a unique artwork for your product. Describe your vision and our AI will bring it to life.",
      "info": "Leave as default to use dynamic product description"
    },
    {
      "type": "checkbox",
      "id": "show_style_presets",
      "label": "Show Style Presets",
      "default": true
    },
    {
      "type": "range",
      "id": "studio_height",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Studio Height",
      "default": 600
    }
  ]
}
{% endschema %}

<div class="ai-art-studio-block" data-block-id="{{ block.id }}">
  {% if heading != blank %}
    <h2 class="ai-art-studio__heading">{{ heading }}</h2>
  {% endif %}
  
  {% if description != blank %}
    <p class="ai-art-studio__description">{{ description }}</p>
  {% endif %}

  <div 
    id="ai-art-studio-container-{{ block.id }}"
    class="ai-art-studio__container"
    data-app-url="{{ app_url }}"
    data-product-type-id="{{ product_type_id }}"
    data-product-id="{{ product.id }}"
    data-product-handle="{{ product.handle }}"
    data-product-title="{{ product.title | escape }}"
    data-display-name="{{ display_name | escape }}"
    data-show-presets="{{ block.settings.show_style_presets }}"
    data-selected-variant="{{ product.selected_or_first_available_variant.id }}"
    data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
    data-customer-email="{% if customer %}{{ customer.email | escape }}{% endif %}"
    data-customer-name="{% if customer %}{{ customer.first_name | escape }}{% endif %}"
    data-shop-domain="{{ shop.permanent_domain }}"
    style="height: {{ block.settings.studio_height }}px;"
  >
    <div class="ai-art-studio__loading">
      <div class="ai-art-studio__spinner"></div>
      <p>Loading design studio...</p>
    </div>
  </div>
</div>

<style>
  .ai-art-studio-block {
    padding: 2rem 0;
    margin: 2rem 0;
  }

  .ai-art-studio__heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .ai-art-studio__description {
    color: #666;
    text-align: center;
    margin-bottom: 1.5rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .ai-art-studio__container {
    width: 100%;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
    position: relative;
  }

  .ai-art-studio__container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .ai-art-studio__loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .ai-art-studio__spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e5e5;
    border-top-color: #333;
    border-radius: 50%;
    animation: ai-art-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes ai-art-spin {
    to { transform: rotate(360deg); }
  }

  .ai-art-studio__error {
    padding: 2rem;
    text-align: center;
    color: #dc2626;
  }

  /* Mockup Preview Section - Guaranteed fallback for all themes */
  .ai-art-mockup-preview {
    display: none;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
  }

  .ai-art-mockup-preview__title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    text-align: center;
    color: #333;
  }

  .ai-art-mockup-preview__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    max-width: 800px;
    margin: 0 auto;
  }

  .ai-art-mockup-preview__item {
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 6px;
    border: 1px solid #e5e5e5;
    background: #fafafa;
  }

  .ai-art-mockup-preview__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  @media (min-width: 768px) {
    .ai-art-mockup-preview__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<script>
  (function() {
    // IMMEDIATE DEBUG - This should always log if script runs
    console.log('[AI Art Studio] Script executing, block id: {{ block.id }}');
    
    const container = document.getElementById('ai-art-studio-container-{{ block.id }}');
    if (!container) {
      console.log('[AI Art Studio] Container not found!');
      return;
    }
    console.log('[AI Art Studio] Container found');

    const appUrl = container.dataset.appUrl;
    console.log('[AI Art Studio] appUrl:', appUrl);
    if (!appUrl) {
      container.innerHTML = '<div class="ai-art-studio__error">This product has not been configured for the design studio. Please publish it from the AI Art Studio admin.</div>';
      return;
    }

    const productTypeId = container.dataset.productTypeId || '1';
    const productId = container.dataset.productId;
    const productHandle = container.dataset.productHandle;
    const productTitle = container.dataset.productTitle;
    const displayName = container.dataset.displayName || productTitle;
    const showPresets = container.dataset.showPresets === 'true';
    const selectedVariant = container.dataset.selectedVariant;
    const customerId = container.dataset.customerId || '';
    const customerEmail = container.dataset.customerEmail || '';
    const customerName = container.dataset.customerName || '';
    
    const shopDomain = container.dataset.shopDomain || window.Shopify?.shop || window.location.hostname;
    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedDesignId = urlParams.get('sharedDesignId');
    
    const params = new URLSearchParams();
    params.set('embedded', 'true');
    params.set('shopify', 'true');
    params.set('shop', shopDomain);
    params.set('productTypeId', productTypeId);
    params.set('productId', productId);
    params.set('productHandle', productHandle);
    params.set('productTitle', productTitle);
    params.set('displayName', displayName);
    params.set('showPresets', showPresets.toString());
    params.set('selectedVariant', selectedVariant);
    if (customerId) {
      params.set('customerId', customerId);
      params.set('customerEmail', customerEmail);
      params.set('customerName', customerName);
    }
    if (sharedDesignId) {
      params.set('sharedDesignId', sharedDesignId);
    }

    const iframe = document.createElement('iframe');
    iframe.src = `${appUrl}/embed/design?${params.toString()}`;
    iframe.allow = 'clipboard-write';
    iframe.title = 'AI Art Design Studio';

    iframe.onload = function() {
      const loading = container.querySelector('.ai-art-studio__loading');
      if (loading) loading.remove();
    };

    container.appendChild(iframe);

    // Store the expected origin for message validation
    let expectedOrigin = null;
    try {
      if (appUrl) {
        expectedOrigin = new URL(appUrl).origin;
      }
    } catch (e) {
      console.warn('[AI Art Studio] Could not parse appUrl:', appUrl);
    }
    
    // Also get origin from the iframe once it's created
    let iframeOrigin = null;
    try {
      iframeOrigin = new URL(iframe.src).origin;
    } catch (e) {}
    
    console.log('[AI Art Studio] Message listener initialized. Expected origins:', expectedOrigin, iframeOrigin);
    
    window.addEventListener('message', function(event) {
      // Debug: Log ALL messages to help troubleshoot
      try {
        const msgType = event.data && event.data.type;
        if (msgType && (msgType.includes('art-studio') || msgType === 'AI_ART_STUDIO_MOCKUPS')) {
          console.log('[AI Art Studio] Received message:', msgType, 'from origin:', event.origin);
        }
      } catch (e) {
        // Ignore errors from checking message type
      }
      
      // Accept messages from either the configured appUrl or the iframe's actual origin
      const isValidOrigin = (expectedOrigin && event.origin === expectedOrigin) || 
                            (iframeOrigin && event.origin === iframeOrigin) ||
                            (event.origin && event.origin.includes('replit'));
      
      if (!isValidOrigin) {
        // Only log rejection for our message types to avoid noise
        if (event.data && event.data.type && (event.data.type.includes('art-studio') || event.data.type === 'AI_ART_STUDIO_MOCKUPS')) {
          console.warn('[AI Art Studio] Rejected message from:', event.origin, 'expected:', expectedOrigin || iframeOrigin);
        }
        return;
      }

      const data = event.data;
      
      if (data.type === 'ai-art-studio:add-to-cart') {
        const variantId = data.variantId;
        const artworkUrl = data.artworkUrl;
        const designId = data.designId;

        const formData = {
          items: [{
            id: variantId,
            quantity: 1,
            properties: {
              '_artwork_url': artworkUrl,
              '_design_id': designId,
              'Artwork': 'Custom AI Design'
            }
          }]
        };

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(result => {
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: true,
            cart: result
          }, appUrl);
          
          document.dispatchEvent(new CustomEvent('cart:refresh'));
          
          if (window.location.pathname !== '/cart') {
            const cartDrawer = document.querySelector('[data-cart-drawer]');
            if (cartDrawer) {
              cartDrawer.classList.add('is-active');
            }
          }
        })
        .catch(error => {
          console.error('Failed to add to cart:', error);
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: false,
            error: error.message
          }, appUrl);
        });
      }

      if (data.type === 'ai-art-studio:resize') {
        container.style.height = data.height + 'px';
      }

      // Handle mockup updates from the AI generator
      if (data.type === 'AI_ART_STUDIO_MOCKUPS') {
        const mockupUrls = data.mockupUrls;
        if (!mockupUrls || mockupUrls.length === 0) return;
        
        console.log('[AI Art Studio] Received mockup URLs:', mockupUrls.length);
        
        // STRATEGY 1: Try common theme-specific selectors first
        const imageSelectors = [
          '.product__media-item img',
          '.product-gallery__image',
          '.product-single__photo img',
          '.product__photo img',
          '[data-product-featured-image]',
          '.product-featured-media img',
          '.product__main-photos img',
          '.product__media img',
          '.product-image img',
          '.product-single__media img',
          '[data-media-id] img',
          '.product-gallery img',
          '.product__images img',
          '.product-images img'
        ];
        
        let productImages = [];
        for (const selector of imageSelectors) {
          productImages = document.querySelectorAll(selector);
          if (productImages.length > 0) {
            console.log('[AI Art Studio] Found images via selector:', selector);
            break;
          }
        }
        
        // Find the product media container for scoped searches
        const productMediaContainer = 
          document.querySelector('[data-product-media-container]') ||
          document.querySelector('[data-product-media]') ||
          document.querySelector('.product__media-list') ||
          document.querySelector('.product__media') ||
          document.querySelector('.product-media') ||
          document.querySelector('.product-gallery') ||
          document.querySelector('.product__images') ||
          document.querySelector('[data-section-type="product"]') ||
          document.querySelector('.product') ||
          document.querySelector('main');
        
        // STRATEGY 2: Find images by Shopify CDN URL pattern (scoped to product area)
        if (productImages.length === 0 && productMediaContainer) {
          const containerImages = productMediaContainer.querySelectorAll('img');
          const shopifyProductImages = Array.from(containerImages).filter(img => {
            const src = img.src || img.dataset.src || '';
            // Shopify CDN patterns: cdn.shopify.com/s/files or /products/
            return (src.includes('cdn.shopify.com') && src.includes('/products/')) ||
                   (src.includes('cdn.shopify.com') && src.includes('/files/'));
          });
          
          if (shopifyProductImages.length > 0) {
            console.log('[AI Art Studio] Found images via CDN pattern:', shopifyProductImages.length);
            productImages = shopifyProductImages;
          }
        }
        
        // STRATEGY 3: Find large images in product section
        if (productImages.length === 0 && productMediaContainer) {
          const sectionImages = productMediaContainer.querySelectorAll('img');
          // Filter to reasonably sized images (likely product images, not icons)
          const largeImages = Array.from(sectionImages).filter(img => {
            return img.naturalWidth > 200 || img.width > 200 ||
                   (img.style.width && parseInt(img.style.width) > 200);
          });
          
          if (largeImages.length > 0) {
            console.log('[AI Art Studio] Found large images in product section:', largeImages.length);
            productImages = largeImages;
          }
        }
        
        // STRATEGY 4: Handle data-media-id wrappers (common in OS 2.0 themes)
        if (productImages.length === 0 && productMediaContainer) {
          const mediaWrappers = productMediaContainer.querySelectorAll('[data-media-id]');
          if (mediaWrappers.length > 0) {
            console.log('[AI Art Studio] Found media wrappers:', mediaWrappers.length);
            mockupUrls.forEach((url, index) => {
              if (mediaWrappers[index]) {
                const wrapper = mediaWrappers[index];
                // Check for img inside
                const img = wrapper.querySelector('img');
                if (img) {
                  updateImageElement(img, url);
                }
                // Update background-image if present
                if (wrapper.style.backgroundImage) {
                  wrapper.dataset.originalBg = wrapper.style.backgroundImage;
                  wrapper.style.backgroundImage = `url('${url}')`;
                }
                // Handle model-viewer elements (3D models - update poster)
                const modelViewer = wrapper.querySelector('model-viewer');
                if (modelViewer) {
                  modelViewer.dataset.originalPoster = modelViewer.poster || '';
                  modelViewer.poster = url;
                }
                // Handle video elements (update poster)
                const video = wrapper.querySelector('video');
                if (video) {
                  video.dataset.originalPoster = video.poster || '';
                  video.poster = url;
                }
              }
            });
            // Mark that we updated something
            productImages = mediaWrappers;
          }
        }
        
        // STRATEGY 5: Find and update background-image galleries (no img elements)
        if (productImages.length === 0 && productMediaContainer) {
          // Find elements with computed background-image containing Shopify CDN
          const allElements = productMediaContainer.querySelectorAll('*');
          const bgImageElements = Array.from(allElements).filter(el => {
            const bgImage = window.getComputedStyle(el).backgroundImage;
            return bgImage && bgImage !== 'none' && 
                   (bgImage.includes('cdn.shopify.com') || bgImage.includes('shopify.com/s/files'));
          });
          
          if (bgImageElements.length > 0) {
            console.log('[AI Art Studio] Found background-image elements:', bgImageElements.length);
            mockupUrls.forEach((url, index) => {
              if (bgImageElements[index]) {
                const el = bgImageElements[index];
                if (!el.dataset.originalBg) {
                  el.dataset.originalBg = el.style.backgroundImage || window.getComputedStyle(el).backgroundImage;
                }
                el.style.backgroundImage = `url('${url}')`;
              }
            });
            productImages = bgImageElements;
          }
        }
        
        // STRATEGY 6: Find media container near add-to-cart form
        if (productImages.length === 0) {
          const addToCartForm = document.querySelector('form[action*="/cart/add"]') ||
                                 document.querySelector('[data-product-form]') ||
                                 document.querySelector('.product-form');
          
          if (addToCartForm) {
            // Look for media/gallery sibling or ancestor
            const productSection = addToCartForm.closest('section') || addToCartForm.closest('.product');
            if (productSection) {
              const sectionImages = productSection.querySelectorAll('img');
              const largeImages = Array.from(sectionImages).filter(img => {
                const rect = img.getBoundingClientRect();
                return rect.width > 100 && rect.height > 100;
              });
              
              if (largeImages.length > 0) {
                console.log('[AI Art Studio] Found images near add-to-cart:', largeImages.length);
                mockupUrls.forEach((url, index) => {
                  if (largeImages[index]) {
                    updateImageElement(largeImages[index], url);
                  }
                });
                productImages = largeImages;
              }
            }
          }
        }
        
        // Helper to update an image element with all lazy-loading patterns
        function updateImageElement(img, url) {
          // Store original values for potential reset
          if (!img.dataset.originalSrc) {
            img.dataset.originalSrc = img.src || '';
            if (img.dataset.src) img.dataset.originalDataSrc = img.dataset.src;
            if (img.dataset.srcset) img.dataset.originalDataSrcset = img.dataset.srcset;
            if (img.dataset.master) img.dataset.originalDataMaster = img.dataset.master;
          }
          
          // Update all src variants (handles lazy-loading themes)
          img.src = url;
          img.srcset = '';
          if (img.dataset.src) img.dataset.src = url;
          if (img.dataset.srcset) img.dataset.srcset = url;
          if (img.dataset.master) img.dataset.master = url;
          
          // Handle Shopify Dawn/OS 2.0 lazy loading
          img.removeAttribute('loading');
          img.classList.remove('lazyload', 'lazyloading');
          img.classList.add('lazyloaded');
          
          // Update parent picture element sources
          const picture = img.closest('picture');
          if (picture) {
            picture.querySelectorAll('source').forEach(source => {
              source.srcset = url;
              if (source.dataset.srcset) source.dataset.srcset = url;
            });
          }
          
          // Handle background-image containers
          const parent = img.parentElement;
          if (parent && parent.style.backgroundImage) {
            parent.dataset.originalBg = parent.style.backgroundImage;
            parent.style.backgroundImage = `url('${url}')`;
          }
        }
        
        // Update found product images
        if (productImages.length > 0) {
          console.log('[AI Art Studio] Updating', Math.min(productImages.length, mockupUrls.length), 'product images');
          mockupUrls.forEach((url, index) => {
            if (productImages[index]) {
              updateImageElement(productImages[index], url);
            }
          });
        }
        
        // Also try to update thumbnail images if they exist
        const thumbnailSelectors = [
          '.product__media-toggle img',
          '.product-thumbnails img',
          '.product__thumbs img',
          '[data-thumbnail-id] img',
          '.product-single__thumbnails img',
          '.product__thumbnail img',
          '.thumbnail-list img',
          '[data-thumbnail] img'
        ];
        
        for (const selector of thumbnailSelectors) {
          const thumbnails = document.querySelectorAll(selector);
          if (thumbnails.length > 0) {
            console.log('[AI Art Studio] Updating thumbnails via:', selector);
            mockupUrls.forEach((url, index) => {
              if (thumbnails[index]) {
                updateImageElement(thumbnails[index], url);
              }
            });
            break;
          }
        }
        
        // GUARANTEED FALLBACK: Always show mockups in our own preview section
        // This ensures mockups are visible even if theme gallery couldn't be updated
        let mockupPreview = document.getElementById('ai-art-mockup-preview-{{ block.id }}');
        const galleryWasUpdated = productImages.length > 0;
        
        if (!mockupPreview) {
          // Create the preview section
          mockupPreview = document.createElement('div');
          mockupPreview.id = 'ai-art-mockup-preview-{{ block.id }}';
          mockupPreview.className = 'ai-art-mockup-preview';
          const title = galleryWasUpdated 
            ? 'All Design Previews' 
            : 'Your Custom Design Preview';
          mockupPreview.innerHTML = '<h3 class="ai-art-mockup-preview__title">' + title + '</h3><div class="ai-art-mockup-preview__grid"></div>';
          // Insert before the design studio container
          container.parentNode.insertBefore(mockupPreview, container);
        } else {
          // Update title based on whether gallery was updated
          const titleEl = mockupPreview.querySelector('.ai-art-mockup-preview__title');
          if (titleEl) {
            titleEl.textContent = galleryWasUpdated ? 'All Design Previews' : 'Your Custom Design Preview';
          }
        }
        
        const previewGrid = mockupPreview.querySelector('.ai-art-mockup-preview__grid');
        previewGrid.innerHTML = ''; // Clear existing
        
        mockupUrls.forEach((url, index) => {
          const imgWrapper = document.createElement('div');
          imgWrapper.className = 'ai-art-mockup-preview__item';
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Design Preview ' + (index + 1);
          img.loading = 'lazy';
          imgWrapper.appendChild(img);
          previewGrid.appendChild(imgWrapper);
        });
        
        mockupPreview.style.display = 'block';
        console.log('[AI Art Studio] Mockup preview section updated with', mockupUrls.length, 'images');
      }
    });
  })();
</script>

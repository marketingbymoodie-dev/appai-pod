{% comment %}
  AI Art Studio - Product Page Design Block
  Embeds the AI artwork customization studio directly on product pages.
  Reads product variants to populate size/frame color options.
{% endcomment %}

{% schema %}
{
  "name": "AI Art Design Studio",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "The URL of your AI Art Studio app (e.g., https://your-app.replit.app)",
      "default": ""
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Create Your Custom Design"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Section Description",
      "default": "Use AI to generate a unique artwork for your pillow. Describe your vision and our AI will bring it to life."
    },
    {
      "type": "checkbox",
      "id": "show_style_presets",
      "label": "Show Style Presets",
      "default": true
    },
    {
      "type": "range",
      "id": "studio_height",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Studio Height",
      "default": 600
    }
  ],
  "presets": [
    {
      "name": "AI Art Design Studio",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<div class="ai-art-studio-block" data-block-id="{{ block.id }}">
  {% if block.settings.heading != blank %}
    <h2 class="ai-art-studio__heading">{{ block.settings.heading }}</h2>
  {% endif %}
  
  {% if block.settings.description != blank %}
    <p class="ai-art-studio__description">{{ block.settings.description }}</p>
  {% endif %}

  <div 
    id="ai-art-studio-container-{{ block.id }}"
    class="ai-art-studio__container"
    data-app-url="{{ block.settings.app_url }}"
    data-product-id="{{ product.id }}"
    data-product-handle="{{ product.handle }}"
    data-product-title="{{ product.title | escape }}"
    data-show-presets="{{ block.settings.show_style_presets }}"
    data-variants='{{ product.variants | json | escape }}'
    data-selected-variant="{{ product.selected_or_first_available_variant.id }}"
    style="height: {{ block.settings.studio_height }}px;"
  >
    <div class="ai-art-studio__loading">
      <div class="ai-art-studio__spinner"></div>
      <p>Loading design studio...</p>
    </div>
  </div>
</div>

<style>
  .ai-art-studio-block {
    padding: 2rem 0;
    margin: 2rem 0;
  }

  .ai-art-studio__heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .ai-art-studio__description {
    color: #666;
    text-align: center;
    margin-bottom: 1.5rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .ai-art-studio__container {
    width: 100%;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
    position: relative;
  }

  .ai-art-studio__container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .ai-art-studio__loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .ai-art-studio__spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e5e5;
    border-top-color: #333;
    border-radius: 50%;
    animation: ai-art-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes ai-art-spin {
    to { transform: rotate(360deg); }
  }

  .ai-art-studio__error {
    padding: 2rem;
    text-align: center;
    color: #dc2626;
  }
</style>

<script>
  (function() {
    const container = document.getElementById('ai-art-studio-container-{{ block.id }}');
    if (!container) return;

    const appUrl = container.dataset.appUrl;
    if (!appUrl) {
      container.innerHTML = '<div class="ai-art-studio__error">Please configure the App URL in the theme editor.</div>';
      return;
    }

    const productId = container.dataset.productId;
    const productHandle = container.dataset.productHandle;
    const productTitle = container.dataset.productTitle;
    const showPresets = container.dataset.showPresets === 'true';
    const selectedVariant = container.dataset.selectedVariant;
    
    let variants = [];
    try {
      variants = JSON.parse(container.dataset.variants || '[]');
    } catch (e) {
      console.error('Failed to parse variants:', e);
    }

    const sizeOptions = [];
    const frameColorOptions = [];
    
    variants.forEach(variant => {
      if (variant.option1 && !sizeOptions.includes(variant.option1)) {
        sizeOptions.push(variant.option1);
      }
      if (variant.option2 && !frameColorOptions.includes(variant.option2)) {
        frameColorOptions.push(variant.option2);
      }
    });

    const shopDomain = window.Shopify?.shop || window.location.hostname;
    
    const params = new URLSearchParams({
      embedded: 'true',
      shopify: 'true',
      shop: shopDomain,
      productId: productId,
      productHandle: productHandle,
      productTitle: encodeURIComponent(productTitle),
      showPresets: showPresets.toString(),
      sizes: sizeOptions.join(','),
      frameColors: frameColorOptions.join(','),
      selectedVariant: selectedVariant,
      variants: encodeURIComponent(JSON.stringify(variants))
    });

    const iframe = document.createElement('iframe');
    iframe.src = `${appUrl}/embed/design?${params.toString()}`;
    iframe.allow = 'clipboard-write';
    iframe.title = 'AI Art Design Studio';

    iframe.onload = function() {
      const loading = container.querySelector('.ai-art-studio__loading');
      if (loading) loading.remove();
    };

    container.appendChild(iframe);

    window.addEventListener('message', function(event) {
      if (event.origin !== new URL(appUrl).origin) return;

      const data = event.data;
      
      if (data.type === 'ai-art-studio:add-to-cart') {
        const variantId = data.variantId;
        const artworkUrl = data.artworkUrl;
        const designId = data.designId;

        const formData = {
          items: [{
            id: variantId,
            quantity: 1,
            properties: {
              '_artwork_url': artworkUrl,
              '_design_id': designId,
              'Artwork': 'Custom AI Design'
            }
          }]
        };

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(result => {
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: true,
            cart: result
          }, appUrl);
          
          document.dispatchEvent(new CustomEvent('cart:refresh'));
          
          if (window.location.pathname !== '/cart') {
            const cartDrawer = document.querySelector('[data-cart-drawer]');
            if (cartDrawer) {
              cartDrawer.classList.add('is-active');
            }
          }
        })
        .catch(error => {
          console.error('Failed to add to cart:', error);
          iframe.contentWindow.postMessage({
            type: 'ai-art-studio:cart-updated',
            success: false,
            error: error.message
          }, appUrl);
        });
      }

      if (data.type === 'ai-art-studio:resize') {
        container.style.height = data.height + 'px';
      }
    });
  })();
</script>
